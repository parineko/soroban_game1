---
// GameScreen.astro
// ã‚²ãƒ¼ãƒ ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
---

<div class="screen game-screen" data-screen="game" style="display: none;">
  <div class="panel game-panel">
    <div class="game-header">
      <div class="game-header-left">
        <p id="level-label" class="badge">ã‚Œã¹ã‚‹ï¼šã—ã‚‡ãã‚…ã† ğŸŒ¸</p>
        <p id="question-counter" class="badge">ã‚‚ã‚“ã™ã†ï¼š1 / 10</p>
      </div>
      <button class="btn-back" data-action="give-up">æˆ»ã‚‹ ğŸ </button>
    </div>

    <div class="instruction-box">
      <p class="instruction">
        ãã‚ã°ã‚“ã® ã‹ãšã‚’ ãŠã¼ãˆã¦<br>
        ã¿ãã® ã§ã‚“ãŸãã§ ã“ãŸãˆã‚’ ã„ã‚Œã¦ã­ ğŸ’¡
      </p>
    </div>

    <div class="abacus-and-controls">
      <div id="abacus-area" class="abacus-area">
        <div class="abacus-wrapper">
          <!-- ãã‚ã°ã‚“ã¯ gameController.js ã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
          <div id="abacus-display-container"></div>
        </div>
      </div>

      <div class="control-area">
        <div id="countdown" class="countdown" style="display: none;"></div>
        <div id="feedback" class="feedback"></div>
        
        <div class="answer-area">
          <div id="answer-display" class="answer-display"></div>
          <div class="scroll-buttons">
            <button class="scroll-btn" id="scroll-up" aria-label="ä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«">â–²</button>
            <button class="scroll-btn" id="scroll-down" aria-label="ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«">â–¼</button>
          </div>
        </div>

        <div class="keypad">
          <div class="keypad-row">
            <button class="key-btn" data-key="7">7</button>
            <button class="key-btn" data-key="8">8</button>
            <button class="key-btn" data-key="9">9</button>
          </div>
          <div class="keypad-row">
            <button class="key-btn" data-key="4">4</button>
            <button class="key-btn" data-key="5">5</button>
            <button class="key-btn" data-key="6">6</button>
          </div>
          <div class="keypad-row">
            <button class="key-btn" data-key="1">1</button>
            <button class="key-btn" data-key="2">2</button>
            <button class="key-btn" data-key="3">3</button>
          </div>
          <div class="keypad-row">
            <button class="key-btn" data-key="0">0</button>
            <button class="key-btn" data-key="del">ã‘ã™</button>
            <button class="key-btn" data-key="enter">ã‘ã£ã¦ã„</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .game-screen {
    width: 100%;
  }

  .game-panel {
    padding-bottom: 14px;
  }

  .game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    margin-bottom: 10px;
  }

  .game-header-left {
    display: flex;
    gap: 6px;
  }

  .btn-back {
    border: none;
    border-radius: 12px;
    padding: 8px 16px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    background: #8b7e71;
    color: #ffffff;
    transition: all 0.15s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    border: 2px solid #6b5f52;
  }

  .btn-back:hover {
    background: #6b5f52;
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);
  }

  .btn-back:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }

  .badge {
    background: #f7ebdb;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 0.82rem;
    color: var(--text-subtle);
  }

  /* ã‚²ãƒ¼ãƒ ç”»é¢ã®2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .abacus-and-controls {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    width: 100%;
    gap: 32px;
    margin: 20px 0;
    min-height: 700px;
  }

  /* å·¦å´ï¼šãã‚ã°ã‚“ã‚¨ãƒªã‚¢ï¼ˆå›ºå®šå¹…500pxï¼‰ */
  .abacus-area {
    width: 500px;
    flex-shrink: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .abacus-wrapper {
    width: 500px;
    height: 700px;
    position: relative;
    border: 2px solid #d4c4b0;
    border-radius: 12px;
    background: #faf8f5;
    overflow: hidden;
  }

  #abacus-display-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  /* å³å´ï¼šã“ãŸãˆå…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆå†…å®¹ã«å¿œã˜ãŸè‡ªç„¶ãªå¹…ï¼‰ */
  .control-area {
    width: auto;
    flex: none;
    min-width: 300px;
    max-width: 350px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: stretch;
  }

  .instruction-box {
    text-align: center;
    margin-top: 2px;
  }

  .instruction {
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--text-main);
  }

  .answer-area {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
  }

  .answer-display {
    flex: 1;
    min-height: 100px;
    max-height: 200px;
    border-radius: 12px;
    border: 1px solid var(--border-soft);
    background: #fff9f0;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 20px 24px;
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--text-main);
    text-align: right;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .scroll-buttons {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .scroll-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 2px solid #d4c4b0;
    background: #f3e1d2;
    color: var(--text-main);
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
    padding: 0;
  }

  .scroll-btn:hover {
    background: #e8d0b8;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .scroll-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .feedback {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    text-align: center;
    font-size: 5rem;
    font-weight: bold;
    line-height: 1.3;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    pointer-events: none;
    background: transparent;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), -1px -1px 2px rgba(255, 255, 255, 0.8);
    white-space: nowrap;
    padding: 0 20px;
  }

  .feedback.success {
    color: var(--success);
  }

  .feedback.error {
    color: var(--danger);
  }

  .countdown {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    text-align: center;
    font-size: 8rem;
    font-weight: bold;
    color: var(--accent-pink);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1001;
    pointer-events: none;
    background: transparent;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4), -2px -2px 3px rgba(255, 255, 255, 0.9);
  }


  .keypad {
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex-shrink: 0;
    width: 100%;
  }

  .keypad-row {
    display: flex;
    gap: 10px;
  }

  .key-btn {
    flex: 1;
    aspect-ratio: 1;
    border-radius: 16px;
    border: 2px solid #d4c4b0;
    padding: 0;
    font-size: 1.4rem;
    font-weight: bold;
    background: #f3e1d2;
    color: var(--text-main);
    cursor: pointer;
    transition: all 0.15s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 0;
    max-width: 100%;
  }

  /* æ•°å­—ãƒœã‚¿ãƒ³ï¼ˆ0-9ï¼‰ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¤§ãã */
  .key-btn[data-key="0"],
  .key-btn[data-key="1"],
  .key-btn[data-key="2"],
  .key-btn[data-key="3"],
  .key-btn[data-key="4"],
  .key-btn[data-key="5"],
  .key-btn[data-key="6"],
  .key-btn[data-key="7"],
  .key-btn[data-key="8"],
  .key-btn[data-key="9"] {
    font-size: 1.8rem;
  }

  .key-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    background: #e8d0b8;
  }

  .key-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }
</style>

<script>
  // è¡¨ç¤ºçª“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½
  function setupScrollButtons() {
    const answerDisplay = document.getElementById('answer-display');
    const scrollUpBtn = document.getElementById('scroll-up');
    const scrollDownBtn = document.getElementById('scroll-down');

    if (answerDisplay && scrollUpBtn && scrollDownBtn) {
      scrollUpBtn.addEventListener('click', (e) => {
        e.preventDefault();
        answerDisplay.scrollTop -= 30;
      });

      scrollDownBtn.addEventListener('click', (e) => {
        e.preventDefault();
        answerDisplay.scrollTop += 30;
      });
    }
  }

  // DOMContentLoadedã¾ãŸã¯è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã¾ã§å¾…æ©Ÿ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupScrollButtons);
  } else {
    // æ—¢ã«DOMContentLoadedãŒç™ºç«ã—ã¦ã„ã‚‹å ´åˆ
    setTimeout(setupScrollButtons, 100);
  }

  // ç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ã«ã‚‚å†è¨­å®š
  const gameScreen = document.querySelector('.game-screen');
  if (gameScreen) {
    const observer = new MutationObserver(() => {
      if (gameScreen.style.display !== 'none') {
        setTimeout(setupScrollButtons, 100);
      }
    });
    observer.observe(gameScreen, { attributes: true, attributeFilter: ['style'] });
  }
</script>

