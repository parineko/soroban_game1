---
// GameScreen.astro
// PCレイアウト修正版（テンキーの縦長化防止・サイズ最適化）
---

<div class="screen game-screen" data-screen="game" style="display: none;">
  <div class="panel game-panel">
    
    <div class="game-header">
      <div class="status-bar">
        <span id="level-label" class="mini-badge">初級</span>
        <span id="question-counter" class="mini-badge number-badge">1/10</span>
      </div>
      <button class="btn-back-mini" data-action="give-up">✕</button>
    </div>

    <div class="layout-wrapper">
      
      <div id="abacus-area" class="abacus-area">
        <div class="abacus-wrapper">
          <div id="abacus-display-container"></div>
        </div>
      </div>

      <div class="keypad-area">
        <div class="instruction-container">
          <p id="instruction-text" style="display: none;"></p>
        </div>

        <div class="answer-row">
          <div id="answer-display" class="answer-display"></div>
          <div class="scroll-buttons">
            <button class="scroll-btn" id="scroll-up">▲</button>
            <button class="scroll-btn" id="scroll-down">▼</button>
          </div>
        </div>

        <div class="keypad">
          <div class="keypad-row">
            <button class="key-btn" data-key="7">7</button>
            <button class="key-btn" data-key="8">8</button>
            <button class="key-btn" data-key="9">9</button>
          </div>
          <div class="keypad-row">
            <button class="key-btn" data-key="4">4</button>
            <button class="key-btn" data-key="5">5</button>
            <button class="key-btn" data-key="6">6</button>
          </div>
          <div class="keypad-row">
            <button class="key-btn" data-key="1">1</button>
            <button class="key-btn" data-key="2">2</button>
            <button class="key-btn" data-key="3">3</button>
          </div>
          <div class="keypad-row">
            <button class="key-btn" data-key="0">0</button>
            <button class="key-btn action" data-key="del">けす</button>
            <button class="key-btn action enter" id="enter-btn" data-key="enter">けってい</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* --- 基本設定 --- */
  :global(body.game-screen-active) { /* 親で制御 */ }
  :global(body.game-screen-active .app-header) { display: none !important; }

  .game-screen {
    height: 100%; width: 100%;
    display: flex; flex-direction: column;
  }

  .game-panel {
    height: 100%; width: 100%;
    padding: 10px; box-sizing: border-box;
    display: flex; flex-direction: column;
    background: #faf8f5;
  }

  .game-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 5px; height: 40px; flex-shrink: 0;
  }
  .status-bar { display: flex; gap: 5px; }
  
  .mini-badge {
    background: #e8d0b8; padding: 4px 8px; border-radius: 4px;
    font-size: 0.9rem; font-weight: bold; color: #5d4037;
    font-family: 'SorobanFont', sans-serif !important;
  }

  #question-counter {
    font-family: "Helvetica Neue", Arial, sans-serif !important;
    font-size: 1rem; letter-spacing: 0.5px;
  }

  .btn-back-mini {
    background: #8b7e71; color: #fff; border: none; border-radius: 4px;
    width: 32px; height: 32px; font-weight: bold; cursor: pointer;
  }

  /* --- レイアウト（スマホ・デフォルト） --- */
  .layout-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1; height: 100%; overflow: hidden; gap: 10px;
  }

  .abacus-area {
    flex: 1;
    width: 100%;
    position: relative; 
    display: flex; justify-content: center; align-items: center;
    min-height: 0;
  }

  .abacus-wrapper {
    width: 100%;
    /* 縦横比を維持 */
    aspect-ratio: 100 / 85; 
    max-height: 100%;
    max-width: 500px;
    display: flex; justify-content: center; align-items: center;
  }

  #abacus-display-container {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
  }
  
  :global(#abacus-display-container svg) {
    width: 100%; height: 100%; display: block;
  }

  /* テンキーエリア */
  .keypad-area {
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
    display: flex; flex-direction: column; gap: 8px; min-height: 0;
    flex-shrink: 0;
  }

  .instruction-container {
    min-height: 1.6em;
    display: flex; align-items: center; justify-content: center;
  }
  #instruction-text {
    font-size: 1rem; text-align: center; color: #8b7e71;
    margin: 0; font-weight: bold;
    font-family: 'SorobanFont', sans-serif !important;
  }
  :global(#instruction-text.result-msg) {
    font-size: 1.2rem; color: #4b3b30;
  }

  .answer-row {
    display: flex; gap: 5px;
    height: 18%; min-height: 50px; flex-shrink: 0;
  }

  .answer-display {
    flex: 1;
    background: #fff; border: 2px solid #f0e0c8; border-radius: 8px;
    font-size: 2.5rem; padding: 0 10px;
    display: flex; align-items: center; justify-content: flex-end;
    overflow: hidden; white-space: nowrap; color: #4b3b30;
    transition: background-color 0.3s ease;
    font-family: 'SorobanFont', sans-serif !important;
  }

  :global(.answer-display.center-mode) { justify-content: center !important; }
  :global(.answer-display.success) {
    background-color: #e8f5e9; border-color: #63c27b; color: #2e7d32;
  }
  :global(.answer-display.error) {
    background-color: #ffebee; border-color: #ff7b7b; color: #c62828;
  }

  .scroll-buttons {
    display: flex; flex-direction: column; width: 55px; gap: 2px;
  }
  .scroll-btn {
    flex: 1; background: #f3e1d2; border: 1px solid #d4c4b0;
    border-radius: 4px; font-size: 1.2rem; color: #5d4037;
  }

  .keypad {
    flex: 1; display: flex; flex-direction: column; gap: 6px; padding-bottom: 5px;
  }
  .keypad-row { flex: 1; display: flex; gap: 6px; }
  .key-btn {
    flex: 1; border: none; border-radius: 8px;
    background: #fff8e6; border-bottom: 4px solid #e0d0b8;
    font-size: 1.8rem; font-weight: bold; color: #4b3b30;
    cursor: pointer; touch-action: manipulation;
    font-family: 'SorobanFont', sans-serif !important;
  }
  .key-btn:active {
    transform: translateY(2px); border-bottom-width: 2px; background: #f3e1d2;
  }
  .key-btn.action { font-size: 1.3rem; background: #e8d0b8; border-bottom-color: #cbb094; }
  .key-btn.enter { 
    background: #ff9ecb; color: white; border-bottom-color: #ff7bb0; font-size: 1.3rem; 
  }
  :global(.key-btn.enter.next-mode) {
    background: #63c27b !important; border-bottom-color: #4da864 !important;
  }

  /* --- ★PC対応（ここを修正！） --- */
  @media (min-width: 768px) {
    .layout-wrapper {
      flex-direction: row; /* 横並び */
      align-items: center; /* 縦中央揃え */
      gap: 40px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 40px;
    }
    
    .game-panel {
      padding: 20px; 
      height: 100vh;
      border-radius: 0;
      justify-content: center;
    }

    /* そろばんエリア：残りのスペースで最大化 */
    .abacus-area {
      flex: 1;
      height: 80vh; /* 高さ確保 */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .abacus-wrapper {
      width: 100%;
      max-width: 800px; /* PCでは大きく */
      aspect-ratio: auto; /* 比率はSVGに任せる */
    }

    /* テンキーエリア：幅と高さを「スマホサイズ」に固定 */
    .keypad-area {
      width: 340px; /* 固定幅 */
      height: auto; /* 中身に合わせる */
      flex: none;   /* 伸び縮みさせない */
      margin: 0;
    }

    /* ボタンが縦に伸びないように高さを固定 */
    .keypad-row {
      height: 60px; /* ちょうどいい高さ */
      flex: none;
    }
    
    .answer-row {
      height: 60px;
      flex: none;
    }
    
    .instruction-container {
      margin-bottom: 10px;
    }
  }
</style>

<script>
  function toggleHeader() {
    const gameScreen = document.querySelector('.game-screen');
    if (gameScreen && getComputedStyle(gameScreen).display !== 'none') {
      document.body.classList.add('game-screen-active');
    } else {
      document.body.classList.remove('game-screen-active');
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    toggleHeader();
    new MutationObserver(toggleHeader).observe(
      document.querySelector('.game-screen'), 
      { attributes: true, attributeFilter: ['style'] }
    );
  });
</script>