---
// AbacusDisplay.astro
// 【決定版】スタイル干渉を無視して強制的にレスポンシブ化する記述

interface Props {
  value?: number;
  digits?: number;
}

const { value = 0, digits = 1 } = Astro.props;

// --- 座標とサイズ設定（%指定） ---
// 珠の幅を19%に設定（これをHTMLに直接埋め込みます）
const TAMA_WIDTH = 19.0;
const TAMA_OFFSET = TAMA_WIDTH / 2;

// 棒の位置 (%)
const ROD_X = [15, 38, 61, 84];

// Y座標 (%)
const Y = {
  upperRest: 11.43,
  upperActive: 16.71,
  lowerRest: 64.0,
  lowerActiveStart: 29.29,
  lowerGap: 9.29
};

// --- 計算ロジック ---
const str = value.toString().padStart(digits, "0");
const digitArray = Array.from(str).map(char => parseInt(char, 10));

function getDigit(col: number): number {
  const idx = digits - 1 - (3 - col);
  return idx >= 0 && idx < digitArray.length ? digitArray[idx] : 0;
}

function getUpperY(col: number): number {
  return getDigit(col) >= 5 ? Y.upperActive : Y.upperRest;
}

function getLowerY(col: number, row: number): number {
  const digit = getDigit(col);
  const ones = digit % 5;
  if (row < ones) return Y.lowerActiveStart + row * Y.lowerGap;
  return Y.lowerRest - (3 - row) * Y.lowerGap;
}
---

<div class="abacus-base">
  <img src="/images/dodai.png" alt="土台" class="dodai" />

  {Array.from({ length: 4 }, (_, col) => (
    <>
      <img 
        src="/images/tama.png" 
        class="tama"
        style={`
          left: ${ROD_X[col] - TAMA_OFFSET}%; 
          top: ${getUpperY(col)}%;
          width: ${TAMA_WIDTH}%; 
        `}
      />
      
      {Array.from({ length: 4 }, (_, row) => (
        <img 
          src="/images/tama.png" 
          class="tama"
          style={`
            left: ${ROD_X[col] - TAMA_OFFSET}%; 
            top: ${getLowerY(col, row)}%;
            width: ${TAMA_WIDTH}%; 
          `}
        />
      ))}
    </>
  ))}
</div>

<style>
  .abacus-base {
    position: relative;
    width: 100%;
    /* 高さは指定しない！土台画像のアスペクト比に任せる */
    max-width: 500px; 
    margin: 0 auto;
  }

  .dodai {
    display: block;
    width: 100%;
    height: auto; /* ここが重要：幅に合わせて高さが変わる */
  }

  .tama {
    position: absolute;
    height: auto; /* 幅に合わせて高さが変わる */
    pointer-events: none;
    z-index: 10;
    transition: top 0.2s;
    /* width は style属性で直書きしているのでここでは不要 */
  }
</style>