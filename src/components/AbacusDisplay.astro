---
// AbacusDisplay.astro
// そろばん表示コンポーネント（画像ベース）
// 4桁（4列）× 各5個（上玉1個+下玉4個）= 20個の玉を常に表示
interface Props {
  value?: number;
  digits?: number;
}

const { value = 0, digits = 1 } = Astro.props;

// 棒の中心X座標（4本分）
// 各棒の中心位置を正確に指定
const rodX = [62, 184, 306, 428];

// 玉画像の幅（tama.png = 108px）
const tamaWidth = 108;
// 玉の中心を棒の中心に合わせるためのオフセット
// left = rodX[col] - tamaOffsetX で、玉の中心が棒の中心に一致する
const tamaOffsetX = tamaWidth / 2; // 54px

// 五玉（上玉）のY座標
const upperRestY = 106;     // 休み位置（一番上、梁から離れた位置）
const upperActiveY = 141;  // active位置（梁に寄る位置）

// 下玉（一玉×4）のY座標
const lowerRestTopY = 410;         // 休み位置の一番上（row 0の位置）
const lowerRestY = 469;            // 休み位置の一番下（row 3の位置）
const lowerActiveStartY = 229;     // active開始位置（梁のすぐ下）
const lowerGap = 65;               // 下玉の上下間隔

// 値を各桁に分解
// 右端（col=3）が一の位になるようにする
// 例: value=1234, digits=4 → digitArray=[1,2,3,4] → col=0:千の位, col=1:百の位, col=2:十の位, col=3:一の位
const str = value.toString().padStart(digits, "0");
const digitArray = Array.from(str).map(char => parseInt(char, 10));

// 各列のdigitを取得（存在しない列は0として扱う）
// 右端（col=3）が一の位になるようにする
// 4列固定なので、右端（col=3）がdigitArrayの最後（一の位）を参照する
// digits=1の場合: col=3→digitArray[0](一の位)
// digits=4の場合: col=0→digitArray[0](千), col=1→digitArray[1](百), col=2→digitArray[2](十), col=3→digitArray[3](一)
function getDigit(col: number): number {
  // 右端（col=3）が一の位になるように、colを右から数えた位置に変換
  // col=0,1,2,3 → 右から数えて3,2,1,0 → digitArrayのインデックスに変換
  // 例: value=10, digits=2, digitArray=[1,0]
  // col=3 (右端) → rightToLeftIndex=0 → arrayIndex=2-1-0=1 → digitArray[1]=0 (一の位) ✓
  // col=2 → rightToLeftIndex=1 → arrayIndex=2-1-1=0 → digitArray[0]=1 (十の位) ✓
  const rightToLeftIndex = 3 - col; // 右端が0、左端が3
  const arrayIndex = digits - 1 - rightToLeftIndex; // digitArrayのインデックス
  const result = arrayIndex >= 0 && arrayIndex < digitArray.length ? digitArray[arrayIndex] : 0;
  return result;
}

// 各列の五玉のY座標を計算
function getUpperY(col: number): number {
  return getDigit(col) >= 5 ? upperActiveY : upperRestY;
}

// 各列の下玉のY座標を計算
function getLowerY(col: number, row: number): number {
  const digit = getDigit(col);
  const ones = digit % 5;
  
  // row < ones の場合はactive位置（梁の近く）
  // 上から ones 個だけ activePositionY に移動
  if (row < ones) {
    return lowerActiveStartY + row * lowerGap;
  }
  
  // rest位置: 一番下に4段きれいに均等に並ぶ
  // row 0 → 一番上の下玉（lowerRestY - 3 * lowerGap）
  // row 1 → その下（lowerRestY - 2 * lowerGap）
  // row 2 → その下（lowerRestY - 1 * lowerGap）
  // row 3 → 一番下（lowerRestY）
  // row 0,1,2,3 がそのまま上→下の順で規則正しく均等に並ぶ
  // lowerRestYを基準にして計算する
  return lowerRestY - (3 - row) * lowerGap;
}
---

<div class="abacus-base">
  <img src="/images/dodai.png" alt="そろばんの土台" class="dodai" />

  <!-- 4列分の玉を配置: 各列に上玉1個 + 下玉4個 = 5個ずつ -->
  {Array.from({ length: 4 }, (_, col) => (
    <>
      <!-- 上玉（五玉）: 列 col -->
      <img 
        src="/images/tama.png" 
        alt="そろばんの玉（上）" 
        class={`tama upper U${col}`}
        data-col={col}
        data-type="upper"
        style={`left: ${rodX[col] - tamaOffsetX}px; top: ${getUpperY(col)}px;`}
      />
      
      <!-- 下玉（一玉×4）: 列 col の4段 -->
      {Array.from({ length: 4 }, (_, row) => (
        <img 
          src="/images/tama.png" 
          alt="そろばんの玉（下）" 
          class={`tama lower L${col}_${row}`}
          data-col={col}
          data-row={row}
          data-type="lower"
          style={`left: ${rodX[col] - tamaOffsetX}px; top: ${getLowerY(col, row)}px;`}
        />
      ))}
    </>
  ))}
</div>

<script>
  // 画像読み込みエラー処理
  function setupImageErrorHandler(img) {
    if (img && !img.onerror) {
      img.onerror = () => {
        console.error("画像読み込みに失敗:", img.src);
        // フォールバック画像があれば差し替え、無ければ無視
      };
    }
  }

  // DOMContentLoaded後にすべての画像にエラーハンドラーを設定
  document.addEventListener('DOMContentLoaded', () => {
    const abacusBase = document.querySelector('.abacus-base');
    if (abacusBase) {
      const images = abacusBase.querySelectorAll('img');
      images.forEach(setupImageErrorHandler);
    }
  });
</script>

<style>
  .abacus-base {
    position: relative;
    width: 500px;
    height: 700px;
    overflow: hidden;
    margin-top: -75px;
    margin-bottom: -75px;
  }

  .dodai {
    width: 100%;
    height: 100%;
    display: block;
  }

  .tama {
    position: absolute;
    width: 108px;
    height: 70px;
    opacity: 1;
    pointer-events: none;
    z-index: 10;
    transition: top 0.3s ease;
  }

  /* レスポンシブ対応 */
  @media (max-width: 600px) {
    .abacus-base {
      width: 100%;
      max-width: 500px;
      height: auto;
      aspect-ratio: 500 / 700;
    }

    .dodai {
      width: 100%;
      height: auto;
    }
  }
</style>
