---
// src/pages/RealSoroban.astro
// èª¿æ•´ç”¨ã‚¬ã‚¤ãƒ‰ä»˜ããƒ»ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ç‰ˆ
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout showHeader={false}>
  
  <div class="rotate-warning">
    <p>ğŸ“± ã‚¹ãƒãƒ›ã‚’æ¨ªã«å‘ã‘ã¦ãã ã•ã„ ğŸ”„</p>
  </div>

  <div class="screen real-soroban-screen">
    
    <div class="control-header">
      <button id="btn-reset" class="btn-action btn-reset" aria-label="ã”ç ´ç®—">
        ğŸ—‘ï¸ ã”ç ´ç®—
      </button>

      <button id="btn-home" class="btn-action btn-home" aria-label="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹">
        ğŸ  ã‚‚ã©ã‚‹
      </button>
    </div>

    <div id="abacus-container" class="abacus-container"></div>
  
  </div>
</BaseLayout>

<script>
  /**
   * PureSorobanEngine
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼èª¿æ•´ç”¨ã«æ§‹æˆã‚’æ•´ç†
   */
  class PureSorobanEngine {
    constructor(containerId, config) {
      this.container = document.getElementById(containerId);
      this.config = config;
      this.currentValue = 0; 
      this.digits = config.digits || 13; 
      if (this.container) this.init();
    }

    init() {
      this.container.innerHTML = '';
      const C = this.config;
      const totalWidth = this.digits * C.widthPerDigit;
      const totalHeight = C.height;
      const ns = "http://www.w3.org/2000/svg";
      
      const svg = document.createElementNS(ns, "svg");
      svg.setAttribute("viewBox", `0 0 ${totalWidth} ${totalHeight}`);
      svg.style.width = "100%";
      svg.style.height = "100%";
      svg.style.touchAction = "none"; 

      this.drawBackground(svg, ns, totalWidth, totalHeight);
      this.drawBeads(svg, ns);
      this.container.appendChild(svg);
    }

    drawBackground(svg, ns, w, h) {
      const C = this.config;
      const createRect = (x, y, width, height, fill, stroke) => {
        const rect = document.createElementNS(ns, "rect");
        rect.setAttribute("x", x); rect.setAttribute("y", y);
        rect.setAttribute("width", width); rect.setAttribute("height", height);
        rect.setAttribute("fill", fill);
        if (stroke) {
          rect.setAttribute("stroke", stroke.color);
          rect.setAttribute("stroke-width", stroke.width);
        }
        return rect;
      };

      // å¤–æ ï¼ˆä¸Šä¸‹ï¼‰
      svg.appendChild(createRect(0, 0, w, 15, C.colors.frame));
      svg.appendChild(createRect(0, h - 15, w, 15, C.colors.frame));
      
      // æ¢ï¼ˆã¯ã‚Šï¼šç™½ã„æ£’ï¼‰
      svg.appendChild(createRect(0, C.y.beam, w, C.beamHeight, C.colors.beam, {color: C.colors.beamBorder, width: 1}));

      // æ¡ï¼ˆè»¸ï¼‰ã¨å®šä½ç‚¹ï¼ˆé»’ã„ç‚¹ï¼‰
      for(let i=0; i < this.digits; i++) {
        const cx = (i * C.widthPerDigit) + (C.widthPerDigit / 2);
        
        // è»¸ï¼ˆç«¹ã²ã”ï¼‰
        const rod = createRect(cx - 3, 15, 6, h - 30, C.colors.rod);
        svg.insertBefore(rod, svg.children[2]); 

        // å®šä½ç‚¹ï¼ˆé»’ã„ç‚¹ï¼‰
        // â˜…ä¿®æ­£: è¨ˆç®—å¼ã§ã¯ãªãã€è¨­å®šé…åˆ—(dotColumns)ã«å«ã¾ã‚Œã¦ã„ã‚‹åˆ—ã«ã ã‘æ‰“ã¤
        if (C.dotColumns.includes(i)) {
           const dot = document.createElementNS(ns, "circle");
           dot.setAttribute("cx", cx);
           // ç‚¹ã®ç¸¦ä½ç½®ï¼šæ¢(beam)ã®Yåº§æ¨™ + (æ¢ã®é«˜ã• / 2) = æ¢ã®ã©çœŸã‚“ä¸­
           dot.setAttribute("cy", C.y.beam + (C.beamHeight / 2)); 
           dot.setAttribute("r", 3.5);
           dot.setAttribute("fill", C.colors.dot);
           svg.appendChild(dot);
        }
      }
    }

    drawBeads(svg, ns) {
      const C = this.config;
      for (let col = 0; col < this.digits; col++) {
        const cx = (col * C.widthPerDigit) + (C.widthPerDigit / 2);
        const beadX = cx - (C.bead.width / 2);

        // äº”ç  (ä¸Šã®ç‰)
        const upperBead = this.createBead(ns, beadX, C.y.upperRest, `upper-${col}`);
        upperBead.addEventListener('pointerdown', (e) => this.handleInput(e, col, 'upper', 0));
        svg.appendChild(upperBead);

        // ä¸€ç  (ä¸‹ã®ç‰ 4ã¤)
        for (let row = 0; row < 4; row++) {
          const lowerY = C.y.lowerBase + (row * C.y.lowerGap);
          const lowerBead = this.createBead(ns, beadX, lowerY, `lower-${col}-${row}`);
          lowerBead.addEventListener('pointerdown', (e) => this.handleInput(e, col, 'lower', row));
          svg.appendChild(lowerBead);
        }
      }
    }

    createBead(ns, x, y, id) {
      const C = this.config;
      const img = document.createElementNS(ns, "image");
      img.setAttribute("href", C.bead.imgSrc); 
      img.setAttribute("x", x);
      img.setAttribute("y", y);
      img.setAttribute("width", C.bead.width);
      img.setAttribute("height", C.bead.height);
      img.setAttribute("id", id);
      img.style.cursor = "pointer";
      img.style.transition = "y 0.08s cubic-bezier(0.25, 1, 0.5, 1)"; 
      return img;
    }

    handleInput(e, col, type, row) {
      e.preventDefault();
      const currentDigitVal = this.getDigitValue(this.currentValue, col);
      let newDigitVal = currentDigitVal;
      if (type === 'upper') {
        if (currentDigitVal >= 5) newDigitVal -= 5; else newDigitVal += 5;
      } else {
        const currentOnes = currentDigitVal % 5;
        const clickedPos = row; 
        if (clickedPos < currentOnes) newDigitVal = (currentDigitVal - currentOnes) + clickedPos;
        else newDigitVal = (currentDigitVal - currentOnes) + (clickedPos + 1);
      }
      this.updateDigitValue(col, newDigitVal);
    }

    getDigitValue(totalValue, col) {
      const str = totalValue.toString().padStart(this.digits, "0");
      return parseInt(str[col], 10);
    }

    updateDigitValue(col, newDigitVal) {
      const strVal = this.currentValue.toString().padStart(this.digits, '0');
      const chars = strVal.split('');
      chars[col] = newDigitVal.toString();
      const newValue = parseInt(chars.join(''), 10);
      this.setValue(newValue);
    }

    setValue(value) {
      const maxVal = Math.pow(10, this.digits) - 1;
      this.currentValue = Math.min(Math.max(0, value), maxVal);
      this.render();
    }

    render() {
      const C = this.config;
      const strVal = this.currentValue.toString().padStart(this.digits, "0");

      for (let col = 0; col < this.digits; col++) {
        const digit = parseInt(strVal[col], 10);
        
        // äº”ç ã®å‹•ã
        const upperBead = document.getElementById(`upper-${col}`);
        if (upperBead) {
          const isUpperActive = digit >= 5;
          // ã“ã“ã§ activeï¼ˆä¸‹ãŒã£ãŸçŠ¶æ…‹ï¼‰ã‹ restï¼ˆä¸ŠãŒã£ãŸçŠ¶æ…‹ï¼‰ã‹ã‚’åˆ¤å®š
          upperBead.setAttribute("y", isUpperActive ? C.y.upperActive : C.y.upperRest);
        }

        // ä¸€ç ã®å‹•ã
        const ones = digit % 5;
        for (let row = 0; row < 4; row++) {
          const lowerBead = document.getElementById(`lower-${col}-${row}`);
          if (lowerBead) {
            const isLowerActive = row < ones;
            let targetY;
            if (isLowerActive) {
              // ä¸ŠãŒã£ãŸçŠ¶æ…‹ï¼ˆæ¢ã«ãã£ã¤ãï¼‰
              targetY = (C.y.lowerBase + (row * C.y.lowerGap)) + C.y.lowerActiveOffset;
            } else {
              // ä¸‹ãŒã£ãŸçŠ¶æ…‹ï¼ˆå®šä½ç½®ï¼‰
              targetY = C.y.lowerBase + (row * C.y.lowerGap);
            }
            lowerBead.setAttribute("y", targetY);
          }
        }
      }
    }
  }

  // ==========================================
  // â–¼â–¼â–¼ ã“ã“ãŒæ•°å€¤ã‚’ã„ã˜ã‚‹å ´æ‰€ã§ã™ â–¼â–¼â–¼
  // ==========================================
  const LANDSCAPE_CONFIG = {
    digits: 13,         // æ¡æ•°ï¼ˆ13æ¡ï¼‰
    widthPerDigit: 55,  // 1æ¡ã®å¹…ï¼ˆç‹­ãã™ã‚‹ã¨å…¨ä½“ãŒç¸®ã‚€ï¼‰
    height: 250,        // ç”»é¢å…¨ä½“ã®é«˜ã•åŸºæº–

    // ç‚¹ã‚’æ‰“ã¤åˆ—ï¼ˆ0ã‹ã‚‰å§‹ã¾ã‚‹ç•ªå·ï¼‰
    // å·¦ç«¯ãŒ0, å³ç«¯ãŒ12ã§ã™ã€‚3æ¡åŒºåˆ‡ã‚Šãªã‚‰ [0, 3, 6, 9, 12] ã«ãªã‚Šã¾ã™ã€‚
    dotColumns: [0, 3, 6, 9, 12], 

    beamHeight: 16,     // æ¢ï¼ˆç™½ã„æ£’ï¼‰ã®å¤ªã•

    colors: {
      frame: "#231815", rod: "#d2b48c", beam: "#e6e6e6", 
      beamBorder: "#231815", dot: "#000000"
    },
    bead: { width: 55, height: 32, imgSrc: "/images/tama.png" }, 
    
    // ã€é‡è¦ã€‘ä½ç½®èª¿æ•´ï¼ˆYåº§æ¨™ï¼‰
    // æ•°å€¤ãŒå°ã•ã„ã»ã©ã€Œä¸Šã€ã€å¤§ãã„ã»ã©ã€Œä¸‹ã€ã«å‹•ãã¾ã™
    y: {
      // 1. æ¢ï¼ˆç™½ã„æ£’ï¼‰ã®ç¸¦ä½ç½®
      beam: 65, 

      // 2. äº”ç ï¼ˆä¸Šã®ç‰ï¼‰ã®è¨­å®š
      upperRest: 15,   // ä¸ŠãŒã£ã¦ã„ã‚‹æ™‚ï¼ˆæ•°å­—0ã®æ™‚ï¼‰ã®ä½ç½®
      upperActive: 33, // ä¸‹ãŒã£ã¦ã„ã‚‹æ™‚ï¼ˆæ•°å­—5ã®æ™‚ï¼‰ã®ä½ç½® â˜…æ¢ã«ã¶ã¤ã‹ã‚‰ãªã„ã‚ˆã†èª¿æ•´

      // 3. ä¸€ç ï¼ˆä¸‹ã®ç‰ï¼‰ã®è¨­å®š
      lowerBase: 108,   // ä¸€ç•ªä¸Šã®ç‰(1ã®ç‰)ã®ã€Œå®šä½ç½®ã€
      lowerGap: 32,    // ç‰ã¨ç‰ã®é–“éš”ï¼ˆç‰ã®é«˜ã•ã¨åŒã˜ãã‚‰ã„ã«ã™ã‚‹ï¼‰
      
      // 4. ä¸€ç ãŒå‹•ãå¹…
      // ãƒã‚¤ãƒŠã‚¹å€¤ã«ã™ã‚‹ã¨ä¸Šã«å‹•ãã¾ã™ã€‚ã€Œ-20ã€ãªã‚‰20pxä¸Šã«ä¸ŠãŒã‚‹
      lowerActiveOffset: -27 
    }
  };

  let realSoroban;

  document.addEventListener('DOMContentLoaded', () => {
    realSoroban = new PureSorobanEngine('abacus-container', LANDSCAPE_CONFIG);
    realSoroban.setValue(0);

    // ã”ç ´ç®—ãƒœã‚¿ãƒ³
    const resetBtn = document.getElementById('btn-reset');
    if(resetBtn) {
      resetBtn.addEventListener('click', () => {
        realSoroban.setValue(0);
      });
    }

    // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
    const homeBtn = document.getElementById('btn-home');
    if(homeBtn) {
      homeBtn.addEventListener('click', () => {
        window.location.href = '/';
      });
    }
  });
</script>

<style>
  .real-soroban-screen {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100dvh;
    background-color: #f5f0e6;
    display: none; /* æ¨ªç”»é¢ã«ãªã£ãŸã‚‰ flex ã«ãªã‚‹ */
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    touch-action: none;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒœã‚¿ãƒ³ç½®ãå ´ï¼‰ */
  .control-header {
    position: absolute;
    top: 10px;
    left: 0;
    width: 100%;
    padding: 0 20px;
    display: flex;
    justify-content: space-between; /* ä¸¡ç«¯æƒãˆï¼ˆå·¦ã«ã”ç ´ç®—ã€å³ã«ãƒ›ãƒ¼ãƒ ï¼‰ */
    z-index: 100;
    pointer-events: none; /* é€æ˜éƒ¨åˆ†ã¯ã‚¯ãƒªãƒƒã‚¯ã‚’é€šã™ */
  }

  /* ãƒœã‚¿ãƒ³å…±é€š */
  .btn-action {
    pointer-events: auto; /* ãƒœã‚¿ãƒ³ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ */
    border: none;
    border-radius: 20px;
    padding: 8px 16px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 0 rgba(0,0,0,0.3);
    transition: transform 0.1s;
    font-family: 'Zen Maru Gothic', sans-serif;
  }
  .btn-action:active {
    transform: translateY(4px);
    box-shadow: none;
  }

  /* å·¦ï¼šã”ç ´ç®—ï¼ˆèµ¤ï¼‰ */
  .btn-reset {
    background: #c62828;
    color: white;
    border: 2px solid #8e0000;
  }

  /* å³ï¼šãƒ›ãƒ¼ãƒ ï¼ˆé’/ã‚°ãƒ¬ãƒ¼ï¼‰ */
  .btn-home {
    background: #5d4037;
    color: white;
    border: 2px solid #3e2723;
  }

  .abacus-container {
    width: 95%;
    height: 80%;
    /* å½±ã‚’ã¤ã‘ã¦æµ®ã„ã¦ã„ã‚‹æ„Ÿã‚’å‡ºã™ */
    filter: drop-shadow(0px 10px 15px rgba(0,0,0,0.2));
  }

  /* ç¸¦ç”»é¢ã®è­¦å‘Š */
  @media (orientation: portrait) {
    .rotate-warning {
      display: flex;
      width: 100vw; height: 100dvh;
      justify-content: center; align-items: center;
      background: #333; color: #fff;
      font-size: 1.2rem;
      font-weight: bold;
      position: fixed; top: 0; left: 0; z-index: 9999;
    }
    .real-soroban-screen { display: none; }
  }

  /* æ¨ªç”»é¢ */
  @media (orientation: landscape) {
    .rotate-warning { display: none; }
    .real-soroban-screen { display: flex; }
  }
</style>