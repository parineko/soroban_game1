---
// src/pages/RealSoroban.astro
// ãƒ¦ãƒ¼ã‚¶ãƒ¼èª¿æ•´å€¤é©ç”¨ + ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå´©ã‚Œé˜²æ­¢ç‰ˆ
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout showHeader={false}>
  
  <div class="rotate-warning">
    <p>ğŸ“± ã‚¹ãƒãƒ›ã‚’æ¨ªã«å‘ã‘ã¦ãã ã•ã„ ğŸ”„</p>
  </div>

  <div class="screen real-soroban-screen">
    
    <div class="control-header">
      <div class="header-left">
        <button id="btn-reset" class="btn-action btn-reset" aria-label="ã”ç ´ç®—">
          ğŸ—‘ï¸ ã”ç ´ç®—
        </button>
      </div>
      
      <div class="header-right">
        <button id="btn-fullscreen" class="btn-action btn-func" aria-label="å…¨ç”»é¢è¡¨ç¤º">
          â›¶ å…¨ç”»é¢
        </button>
        <button id="btn-home" class="btn-action btn-home" aria-label="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹">
          ğŸ  ã‚‚ã©ã‚‹
        </button>
      </div>
    </div>

    <div id="abacus-container" class="abacus-container"></div>
  
  </div>
</BaseLayout>

<script>
  /**
   * PureSorobanEngine
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼èª¿æ•´æ¸ˆã¿ã®è¨­å®šã‚’é©ç”¨
   */
  class PureSorobanEngine {
    constructor(containerId, config) {
      this.container = document.getElementById(containerId);
      this.config = config;
      this.currentValue = 0; 
      this.digits = config.digits || 13; 
      if (this.container) this.init();
    }

    init() {
      this.container.innerHTML = '';
      const C = this.config;
      const totalWidth = this.digits * C.widthPerDigit;
      const totalHeight = C.height;
      const ns = "http://www.w3.org/2000/svg";
      
      const svg = document.createElementNS(ns, "svg");
      svg.setAttribute("viewBox", `0 0 ${totalWidth} ${totalHeight}`);
      // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¤ã¤ã€ã‚³ãƒ³ãƒ†ãƒŠã„ã£ã±ã„ã«åºƒã’ã‚‹
      svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
      svg.style.width = "100%";
      svg.style.height = "100%";
      svg.style.touchAction = "none"; 

      this.drawBackground(svg, ns, totalWidth, totalHeight);
      this.drawBeads(svg, ns);
      this.container.appendChild(svg);
    }

    drawBackground(svg, ns, w, h) {
      const C = this.config;
      const createRect = (x, y, width, height, fill, stroke) => {
        const rect = document.createElementNS(ns, "rect");
        rect.setAttribute("x", x); rect.setAttribute("y", y);
        rect.setAttribute("width", width); rect.setAttribute("height", height);
        rect.setAttribute("fill", fill);
        if (stroke) {
          rect.setAttribute("stroke", stroke.color);
          rect.setAttribute("stroke-width", stroke.width);
        }
        return rect;
      };

      // å¤–æ ï¼ˆä¸Šä¸‹ï¼‰
      svg.appendChild(createRect(0, 0, w, 15, C.colors.frame));
      svg.appendChild(createRect(0, h - 15, w, 15, C.colors.frame));
      
      // æ¢ï¼ˆã¯ã‚Šï¼‰
      svg.appendChild(createRect(0, C.y.beam, w, C.beamHeight, C.colors.beam, {color: C.colors.beamBorder, width: 1}));

      // æ¡ã¨å®šä½ç‚¹
      for(let i=0; i < this.digits; i++) {
        const cx = (i * C.widthPerDigit) + (C.widthPerDigit / 2);
        
        // è»¸
        const rod = createRect(cx - 3, 15, 6, h - 30, C.colors.rod);
        svg.insertBefore(rod, svg.children[2]); 

        // å®šä½ç‚¹ï¼ˆæŒ‡å®šã•ã‚ŒãŸåˆ—ã®ã¿ï¼‰
        if (C.dotColumns.includes(i)) {
           const dot = document.createElementNS(ns, "circle");
           dot.setAttribute("cx", cx);
           dot.setAttribute("cy", C.y.beam + (C.beamHeight / 2)); 
           dot.setAttribute("r", 3.5);
           dot.setAttribute("fill", C.colors.dot);
           svg.appendChild(dot);
        }
      }
    }

    drawBeads(svg, ns) {
      const C = this.config;
      for (let col = 0; col < this.digits; col++) {
        const cx = (col * C.widthPerDigit) + (C.widthPerDigit / 2);
        const beadX = cx - (C.bead.width / 2);

        // äº”ç 
        const upperBead = this.createBead(ns, beadX, C.y.upperRest, `upper-${col}`);
        upperBead.addEventListener('pointerdown', (e) => this.handleInput(e, col, 'upper', 0));
        svg.appendChild(upperBead);

        // ä¸€ç 
        for (let row = 0; row < 4; row++) {
          const lowerY = C.y.lowerBase + (row * C.y.lowerGap);
          const lowerBead = this.createBead(ns, beadX, lowerY, `lower-${col}-${row}`);
          lowerBead.addEventListener('pointerdown', (e) => this.handleInput(e, col, 'lower', row));
          svg.appendChild(lowerBead);
        }
      }
    }

    createBead(ns, x, y, id) {
      const C = this.config;
      const img = document.createElementNS(ns, "image");
      img.setAttribute("href", C.bead.imgSrc); 
      img.setAttribute("x", x);
      img.setAttribute("y", y);
      img.setAttribute("width", C.bead.width);
      img.setAttribute("height", C.bead.height);
      img.setAttribute("id", id);
      img.style.cursor = "pointer";
      img.style.transition = "y 0.08s cubic-bezier(0.25, 1, 0.5, 1)"; 
      return img;
    }

    handleInput(e, col, type, row) {
      e.preventDefault();
      const currentDigitVal = this.getDigitValue(this.currentValue, col);
      let newDigitVal = currentDigitVal;
      if (type === 'upper') {
        if (currentDigitVal >= 5) newDigitVal -= 5; else newDigitVal += 5;
      } else {
        const currentOnes = currentDigitVal % 5;
        const clickedPos = row; 
        if (clickedPos < currentOnes) newDigitVal = (currentDigitVal - currentOnes) + clickedPos;
        else newDigitVal = (currentDigitVal - currentOnes) + (clickedPos + 1);
      }
      this.updateDigitValue(col, newDigitVal);
    }

    getDigitValue(totalValue, col) {
      const str = totalValue.toString().padStart(this.digits, "0");
      return parseInt(str[col], 10);
    }

    updateDigitValue(col, newDigitVal) {
      const strVal = this.currentValue.toString().padStart(this.digits, '0');
      const chars = strVal.split('');
      chars[col] = newDigitVal.toString();
      const newValue = parseInt(chars.join(''), 10);
      this.setValue(newValue);
    }

    setValue(value) {
      const maxVal = Math.pow(10, this.digits) - 1;
      this.currentValue = Math.min(Math.max(0, value), maxVal);
      this.render();
    }

    render() {
      const C = this.config;
      const strVal = this.currentValue.toString().padStart(this.digits, "0");

      for (let col = 0; col < this.digits; col++) {
        const digit = parseInt(strVal[col], 10);
        
        // äº”ç 
        const upperBead = document.getElementById(`upper-${col}`);
        if (upperBead) {
          const isUpperActive = digit >= 5;
          upperBead.setAttribute("y", isUpperActive ? C.y.upperActive : C.y.upperRest);
        }

        // ä¸€ç 
        const ones = digit % 5;
        for (let row = 0; row < 4; row++) {
          const lowerBead = document.getElementById(`lower-${col}-${row}`);
          if (lowerBead) {
            const isLowerActive = row < ones;
            let targetY;
            if (isLowerActive) {
              targetY = (C.y.lowerBase + (row * C.y.lowerGap)) + C.y.lowerActiveOffset;
            } else {
              targetY = C.y.lowerBase + (row * C.y.lowerGap);
            }
            lowerBead.setAttribute("y", targetY);
          }
        }
      }
    }
  }

  // ==========================================
  // â–¼â–¼â–¼ ãƒ¦ãƒ¼ã‚¶ãƒ¼èª¿æ•´æ¸ˆã¿ CONFIG â–¼â–¼â–¼
  // ==========================================
  const LANDSCAPE_CONFIG = {
    digits: 13,         // æ¡æ•°ï¼ˆ13æ¡ï¼‰
    widthPerDigit: 55,  // 1æ¡ã®å¹…
    height: 250,        // ç”»é¢å…¨ä½“ã®é«˜ã•åŸºæº–

    // ç‚¹ã‚’æ‰“ã¤åˆ—
    dotColumns: [0, 3, 6, 9, 12], 

    beamHeight: 16,     // æ¢ï¼ˆç™½ã„æ£’ï¼‰ã®å¤ªã•

    colors: {
      frame: "#231815", rod: "#d2b48c", beam: "#e6e6e6", 
      beamBorder: "#231815", dot: "#000000"
    },
    bead: { width: 55, height: 32, imgSrc: "/images/tama.png" }, 
    
    // ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼èª¿æ•´å€¤ã€‘
    y: {
      // 1. æ¢ï¼ˆç™½ã„æ£’ï¼‰ã®ç¸¦ä½ç½®
      beam: 65, 

      // 2. äº”ç ï¼ˆä¸Šã®ç‰ï¼‰ã®è¨­å®š
      upperRest: 15,   
      upperActive: 33, 

      // 3. ä¸€ç ï¼ˆä¸‹ã®ç‰ï¼‰ã®è¨­å®š
      lowerBase: 108,   
      lowerGap: 32,    
      
      // 4. ä¸€ç ãŒå‹•ãå¹…
      lowerActiveOffset: -27 
    }
  };

  let realSoroban;

  document.addEventListener('DOMContentLoaded', () => {
    realSoroban = new PureSorobanEngine('abacus-container', LANDSCAPE_CONFIG);
    realSoroban.setValue(0);

    // ã”ç ´ç®—
    const resetBtn = document.getElementById('btn-reset');
    if(resetBtn) {
      resetBtn.addEventListener('click', () => {
        realSoroban.setValue(0);
      });
    }

    // ãƒ›ãƒ¼ãƒ 
    const homeBtn = document.getElementById('btn-home');
    if(homeBtn) {
      homeBtn.addEventListener('click', () => {
        window.location.href = '/';
      });
    }

    // å…¨ç”»é¢åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    const fsBtn = document.getElementById('btn-fullscreen');
    if(fsBtn) {
      fsBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(err => {
            console.log(`Error attempting to enable fullscreen: ${err.message}`);
          });
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      });
    }
  });
</script>

<style>
  /* --- åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆFlexboxã§ç¸¦ä¸¦ã³ã«ã™ã‚‹ï¼‰ --- */
  .real-soroban-screen {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100dvh;
    background-color: #f5f0e6;
    
    display: none; /* æ¨ªç”»é¢ç”¨ */
    flex-direction: column; /* ä¸Šä¸‹ã«è¦ç´ ã‚’ä¸¦ã¹ã‚‹ */
    overflow: hidden;
    touch-action: none;
  }

  /* --- 1. ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆãƒœã‚¿ãƒ³ç½®ãå ´ï¼‰ --- */
  /* ã“ã“ã§é«˜ã•ã‚’ç¢ºä¿ã™ã‚‹ã®ã§ãƒœã‚¿ãƒ³ãŒãã‚ã°ã‚“ã«è¢«ã‚‰ãªã„ */
  .control-header {
    width: 100%;
    height: 60px; /* ãƒœã‚¿ãƒ³ãŒåã¾ã‚‹é«˜ã• */
    flex-shrink: 0; /* ç¸®ã¾ã›ãªã„ */
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 16px;
    padding-left: max(16px, env(safe-area-inset-left));   /* ãƒãƒƒãƒå¯¾ç­– */
    padding-right: max(16px, env(safe-area-inset-right)); /* ãƒãƒƒãƒå¯¾ç­– */
    background: #eaddcf; /* ç”»é¢ã‚ˆã‚Šå°‘ã—æ¿ƒã„è‰²ã§åŒºåˆ‡ã‚‹ï¼ˆãŠå¥½ã¿ã§å¤‰æ›´å¯ï¼‰ */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    z-index: 10;
  }

  .header-right {
    display: flex;
    gap: 10px;
  }

  /* --- ãƒœã‚¿ãƒ³å…±é€š --- */
  .btn-action {
    border: none;
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 0.85rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 3px 0 rgba(0,0,0,0.2);
    transition: transform 0.1s;
    font-family: 'Zen Maru Gothic', sans-serif;
    white-space: nowrap;
  }
  .btn-action:active {
    transform: translateY(3px);
    box-shadow: none;
  }

  /* å€‹åˆ¥è‰²è¨­å®š */
  .btn-reset { background: #c62828; color: white; border: 2px solid #8e0000; }
  .btn-home { background: #5d4037; color: white; border: 2px solid #3e2723; }
  .btn-func { background: #f0f0f0; color: #333; border: 2px solid #ccc; } /* å…¨ç”»é¢ãƒœã‚¿ãƒ³ */

  /* --- 2. ãã‚ã°ã‚“ã‚¨ãƒªã‚¢ --- */
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ä»¥å¤–ã®æ®‹ã‚Šã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¨ã¦ä½¿ã† */
  .abacus-container {
    flex: 1; /* æ®‹ã‚Šå…¨éƒ¨ */
    width: 100%; 
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 5px 0; /* ä¸Šä¸‹ã«å°‘ã—ã ã‘éš™é–“ */
  }

  /* --- ç”»é¢ã®å‘ãåˆ¶å¾¡ --- */
  @media (orientation: portrait) {
    .rotate-warning {
      display: flex;
      width: 100vw; height: 100dvh;
      justify-content: center; align-items: center;
      background: #333; color: #fff;
      font-size: 1.2rem;
      font-weight: bold;
      position: fixed; top: 0; left: 0; z-index: 9999;
    }
    .real-soroban-screen { display: none; }
  }

  @media (orientation: landscape) {
    .rotate-warning { display: none; }
    .real-soroban-screen { display: flex; }
  }
</style>