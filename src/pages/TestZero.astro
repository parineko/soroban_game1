---
// TestZero.astro
// ãã‚ã°ã‚“ã‚³ã‚¢ã‚¨ãƒ³ã‚¸ãƒ³å®Œæˆç‰ˆï¼ˆã‚¿ãƒƒãƒæ“ä½œãƒ»åŒæ–¹å‘åŒæœŸãƒ»ã‚¯ãƒ©ã‚¹åŒ–æ¸ˆã¿ï¼‰
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout showHeader={false}>
<div class="screen test-screen">
  <div class="panel game-panel">
    <div class="game-header">
      <div class="game-header-left">
        <p class="badge">ãã‚ã°ã‚“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ğŸ’»</p>
      </div>
      <div class="game-header-right">
        <button class="btn-back" onclick="window.location.href='/'" aria-label="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹">ã‚‚ã©ã‚‹ ğŸ </button>
      </div>
    </div>

    <div class="instruction-box">
      <p class="instruction" id="instruction-text">
        ãŸã¾ã‚’ ã‚¿ãƒƒãƒã™ã‚‹ã‹ ã™ã†ã˜ã‚’ ã„ã‚Œã¦ ã‚ãã‚“ã§ã¿ã¦ã­ âœ¨
      </p>
    </div>

    <div class="layout-wrapper">
      <div class="main-area">
        <div id="abacus-area" class="abacus-area">
          <div class="abacus-wrapper">
            <div id="abacus-display-container"></div>
          </div>
        </div>

        <div class="keypad-area">
          <div class="answer-area">
            <div id="answer-display" class="answer-display">0</div>
            <div class="scroll-buttons">
              <button class="scroll-btn" id="scroll-up" aria-label="æ•°å­—ã‚’å¢—ã‚„ã™">â–²</button>
              <button class="scroll-btn" id="scroll-down" aria-label="æ•°å­—ã‚’æ¸›ã‚‰ã™">â–¼</button>
            </div>
          </div>

          <div class="keypad">
            <div class="keypad-row">
              <button class="key-btn" data-key="7">7</button>
              <button class="key-btn" data-key="8">8</button>
              <button class="key-btn" data-key="9">9</button>
            </div>
            <div class="keypad-row">
              <button class="key-btn" data-key="4">4</button>
              <button class="key-btn" data-key="5">5</button>
              <button class="key-btn" data-key="6">6</button>
            </div>
            <div class="keypad-row">
              <button class="key-btn" data-key="1">1</button>
              <button class="key-btn" data-key="2">2</button>
              <button class="key-btn" data-key="3">3</button>
            </div>
            <div class="keypad-row">
              <button class="key-btn" data-key="0">0</button>
              <button class="key-btn" data-key="del">ã‘ã™</button>
              <button class="key-btn" data-key="clear">ã‚¯ãƒªã‚¢</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * SorobanEngine
 * ãã‚ã°ã‚“ã®æç”»ãƒ»æ“ä½œãƒ»çŠ¶æ…‹ç®¡ç†ã‚’è¡Œã†ã‚³ã‚¢ã‚¯ãƒ©ã‚¹
 */
class SorobanEngine {
  constructor(containerId, config, onChangeCallback) {
    this.container = document.getElementById(containerId);
    this.config = config;
    this.onChange = onChangeCallback; // å€¤ãŒå¤‰ã‚ã£ãŸæ™‚ã«å‘¼ã°ã‚Œã‚‹é–¢æ•°
    this.currentValue = 0;
    this.digits = config.digits || 5;
    
    if (this.container) {
      this.init();
    }
  }

  // åˆæœŸåŒ–ï¼ˆSVGã®ç”Ÿæˆï¼‰
  init() {
    this.container.innerHTML = '';
    const C = this.config;
    const totalWidth = this.digits * C.widthPerDigit;
    const totalHeight = C.height;
    const ns = "http://www.w3.org/2000/svg";

    const svg = document.createElementNS(ns, "svg");
    svg.setAttribute("viewBox", `0 0 ${totalWidth} ${totalHeight}`);
    svg.style.width = "100%";
    svg.style.height = "100%";
    
    // --- èƒŒæ™¯æç”» ---
    this.drawBackground(svg, ns, totalWidth, totalHeight);

    // --- ç‰ã®ç”Ÿæˆ ---
    for (let col = 0; col < this.digits; col++) {
      const cx = (col * C.widthPerDigit) + (C.widthPerDigit / 2);
      const beadX = cx - (C.bead.width / 2);

      // äº”ç‰
      const upperBead = this.createBead(ns, beadX, C.y.upperRest, `upper-${col}`);
      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      upperBead.style.cursor = "pointer";
      upperBead.addEventListener('click', () => this.handleBeadClick(col, 'upper', 0));
      svg.appendChild(upperBead);

      // ä¸€ç‰
      for (let row = 0; row < 4; row++) {
        const lowerY = C.y.lowerBase + (row * C.y.lowerGap);
        const lowerBead = this.createBead(ns, beadX, lowerY, `lower-${col}-${row}`);
        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        lowerBead.style.cursor = "pointer";
        lowerBead.addEventListener('click', () => this.handleBeadClick(col, 'lower', row));
        svg.appendChild(lowerBead);
      }
    }
    this.container.appendChild(svg);
  }

  drawBackground(svg, ns, w, h) {
    const C = this.config;
    const createRect = (x, y, width, height, fill, stroke) => {
      const rect = document.createElementNS(ns, "rect");
      rect.setAttribute("x", x); rect.setAttribute("y", y);
      rect.setAttribute("width", width); rect.setAttribute("height", height);
      rect.setAttribute("fill", fill);
      if (stroke) {
        rect.setAttribute("stroke", stroke.color);
        rect.setAttribute("stroke-width", stroke.width);
      }
      return rect;
    };

    // æ 
    svg.appendChild(createRect(0, 0, w, 10, C.colors.frame)); // ä¸Š
    svg.appendChild(createRect(0, h - 10, w, 10, C.colors.frame)); // ä¸‹

    // æ¢
    svg.appendChild(createRect(0, C.y.beam, w, 12, C.colors.beam, {color: C.colors.beamBorder, width: 1}));

    // æ£’ã¨ç‚¹
    for(let i=0; i < this.digits; i++) {
      const cx = (i * C.widthPerDigit) + (C.widthPerDigit / 2);
      // æ£’
      const rod = createRect(cx - 3, 10, 6, h - 20, C.colors.rod);
      // æ¢ã‚ˆã‚Šå¥¥ã«æŒ¿å…¥ï¼ˆæ¢ã®æ¬¡ã«ã‚ã‚‹è¦ç´ ã®å‰ã«æŒ¿å…¥...ã¯é¢å€’ãªã®ã§æ¢ã®rectå–å¾—ãƒ­ã‚¸ãƒƒã‚¯çœç•¥ã§å¾Œã‚ã«è¿½åŠ å¾Œã€z-indexæ¦‚å¿µãªã„ãŸã‚é †åºé‡è¦ï¼‰
      // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€Œæ¢ã®å¾Œã‚(append)ã€ã ã¨æ‰‹å‰ã«æç”»ã•ã‚Œã‚‹ãŸã‚ã€
      // æ¢(3ç•ªç›®ã®å­è¦ç´ )ã®å‰ã«æŒ¿å…¥ã™ã‚‹
      svg.insertBefore(rod, svg.children[2]); 

      // ç‚¹ï¼ˆä¸€ã®ä½ã¨åƒã®ä½ï¼‰
      // å³ã‹ã‚‰0ç•ªç›®(index = digits-1) = 1ã®ä½
      // å³ã‹ã‚‰3ç•ªç›®(index = digits-4) = 1000ã®ä½
      const onePlaceIdx = this.digits - 1;
      const thousandPlaceIdx = this.digits - 4;
      
      if (i === onePlaceIdx || i === thousandPlaceIdx) {
         const dot = document.createElementNS(ns, "circle");
         dot.setAttribute("cx", cx);
         dot.setAttribute("cy", C.y.beam + 6);
         dot.setAttribute("r", 3);
         dot.setAttribute("fill", C.colors.dot);
         svg.appendChild(dot);
      }
    }
  }

  createBead(ns, x, y, id) {
    const C = this.config;
    const img = document.createElementNS(ns, "image");
    img.setAttribute("href", C.bead.imgSrc);
    img.setAttribute("x", x);
    img.setAttribute("y", y);
    img.setAttribute("width", C.bead.width);
    img.setAttribute("height", C.bead.height);
    img.setAttribute("id", id);
    img.style.transition = "y 0.1s ease-out"; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    return img;
  }

  // ç‰ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
  handleBeadClick(col, type, row) {
    // ç¾åœ¨ã®ãã®æ¡ã®å€¤ã‚’å–å¾—
    const currentDigitVal = this.getDigitValue(this.currentValue, col);
    let newDigitVal = currentDigitVal;

    if (type === 'upper') {
      // äº”ç‰ï¼š0ãªã‚‰5ã«ã€5ä»¥ä¸Šãªã‚‰0(ã‚ã‚‹ã„ã¯5å¼•ã)ã«ã™ã‚‹
      if (currentDigitVal >= 5) newDigitVal -= 5;
      else newDigitVal += 5;
    } else {
      // ä¸€ç‰ï¼šã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸä½ç½®(row 0-3)ã¨ç¾åœ¨ã®1ç‰ã®å€¤(0-4)ã‚’æ¯”è¼ƒ
      const currentOnes = currentDigitVal % 5;
      const clickedPos = row; // ä¸Šã‹ã‚‰0,1,2,3ç•ªç›®

      // ãƒ­ã‚¸ãƒƒã‚¯ï¼š
      // ã‚¯ãƒªãƒƒã‚¯ã—ãŸç‰ãŒã€ŒONï¼ˆä¸ŠãŒã£ã¦ã‚‹ï¼‰ã€ãªã‚‰ã€ãã®ç‰ã‚’ã€ŒOFFï¼ˆä¸‹ã’ã‚‹ï¼‰ã€= å€¤ã¯ clickedPos ã«ãªã‚‹
      // ã‚¯ãƒªãƒƒã‚¯ã—ãŸç‰ãŒã€ŒOFFï¼ˆä¸‹ãŒã£ã¦ã‚‹ï¼‰ã€ãªã‚‰ã€ãã®ç‰ã‚’ã€ŒONï¼ˆä¸Šã’ã‚‹ï¼‰ã€ = å€¤ã¯ clickedPos + 1 ã«ãªã‚‹
      
      if (clickedPos < currentOnes) {
        // ONã®ç‰ã‚’è§¦ã£ãŸ -> ä¸‹ã’ã‚‹
        newDigitVal = (currentDigitVal - currentOnes) + clickedPos;
      } else {
        // OFFã®ç‰ã‚’è§¦ã£ãŸ -> ä¸Šã’ã‚‹
        newDigitVal = (currentDigitVal - currentOnes) + (clickedPos + 1);
      }
    }

    // å…¨ä½“ã®å€¤ã‚’æ›´æ–°
    this.updateDigitValue(col, newDigitVal);
  }

  // æŒ‡å®šã—ãŸæ¡ã®å€¤ã‚’æ›´æ–°ã—ã¦å…¨ä½“å€¤ã‚’å†è¨ˆç®—
  updateDigitValue(col, newDigitVal) {
    const strVal = this.currentValue.toString().padStart(this.digits, '0');
    const chars = strVal.split('');
    chars[col] = newDigitVal.toString();
    const newValue = parseInt(chars.join(''), 10);
    
    this.setValue(newValue);
    
    // å¤–éƒ¨ã¸é€šçŸ¥ï¼ˆæ•°å­—è¡¨ç¤ºã®æ›´æ–°ãªã©ï¼‰
    if (this.onChange) this.onChange(newValue);
  }

  getDigitValue(totalValue, col) {
    const str = totalValue.toString().padStart(this.digits, "0");
    return parseInt(str[col], 10);
  }

  // å€¤ã‚’ã‚»ãƒƒãƒˆã—ã¦æç”»æ›´æ–°
  setValue(value) {
    // æœ€å¤§æ¡æ•°ã‚’è¶…ãˆãªã„ã‚ˆã†ã«åˆ¶é™
    const maxVal = Math.pow(10, this.digits) - 1;
    this.currentValue = Math.min(Math.max(0, value), maxVal);
    this.render();
  }

  // ç¾åœ¨ã®å€¤ã«åŸºã¥ã„ã¦ç‰ã®ä½ç½®ã‚’æ›´æ–°
  render() {
    const C = this.config;
    const strVal = this.currentValue.toString().padStart(this.digits, "0");

    for (let col = 0; col < this.digits; col++) {
      const digit = parseInt(strVal[col], 10);

      // --- äº”ç‰æ›´æ–° ---
      const upperBead = document.getElementById(`upper-${col}`);
      if (upperBead) {
        const isUpperActive = digit >= 5;
        upperBead.setAttribute("y", isUpperActive ? C.y.upperActive : C.y.upperRest);
      }

      // --- ä¸€ç‰æ›´æ–° ---
      const ones = digit % 5;
      for (let row = 0; row < 4; row++) {
        const lowerBead = document.getElementById(`lower-${col}-${row}`);
        if (lowerBead) {
          const isLowerActive = row < ones;
          let targetY;
          if (isLowerActive) {
            // ä¸ŠãŒã£ã¦ã„ã‚‹
            targetY = (C.y.lowerBase + (row * C.y.lowerGap)) + C.y.lowerActiveOffset;
          } else {
            // ä¸‹ãŒã£ã¦ã„ã‚‹
            targetY = C.y.lowerBase + (row * C.y.lowerGap);
          }
          lowerBead.setAttribute("y", targetY);
        }
      }
    }
  }
}

// --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
const CONFIG = {
  digits: 5,
  widthPerDigit: 60,
  height: 225, // èª¿æ•´æ¸ˆã¿ã®é«˜ã•
  colors: {
    frame: "#231815", rod: "#deb887", beam: "#e6e6e6", 
    beamBorder: "#231815", dot: "#000000"
  },
  bead: { width: 60, height: 32, imgSrc: "/images/tama.png" },
  y: {
    upperRest: 10, upperActive: 28, beam: 60,
    lowerBase: 91, lowerGap: 31, lowerActiveOffset: -19
  }
};

let soroban; // ã‚¨ãƒ³ã‚¸ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

document.addEventListener('DOMContentLoaded', () => {
  // ãã‚ã°ã‚“ã‚¨ãƒ³ã‚¸ãƒ³ã®èµ·å‹•
  soroban = new SorobanEngine('abacus-display-container', CONFIG, (newValue) => {
    // ç‰ã‚’å‹•ã‹ã—ãŸæ™‚ã«å‘¼ã°ã‚Œã‚‹: æ•°å­—è¡¨ç¤ºã‚’æ›´æ–°
    updateNumberDisplay(newValue);
  });

  // åˆæœŸå€¤ã‚»ãƒƒãƒˆ
  soroban.setValue(0);

  // --- ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---
  
  // ãƒ†ãƒ³ã‚­ãƒ¼ & åˆ¶å¾¡ãƒœã‚¿ãƒ³
  document.body.addEventListener('click', (event) => {
    const button = event.target.closest('button');
    if (!button) return;
    const key = button.getAttribute('data-key');
    if (!key) return;

    event.preventDefault();
    let current = soroban.currentValue;

    if (key === 'del') {
      const str = current.toString();
      soroban.setValue(str.length > 1 ? parseInt(str.slice(0, -1), 10) : 0);
    } else if (key === 'clear') {
      soroban.setValue(0);
    } else if (/^[0-9]$/.test(key)) {
      const num = parseInt(key, 10);
      if (current === 0) soroban.setValue(num);
      else soroban.setValue(current * 10 + num);
    }
    updateNumberDisplay(soroban.currentValue);
  });

  // ä¸Šä¸‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆé•·æŠ¼ã—å¯¾å¿œï¼‰
  setupScrollButton('scroll-up', () => {
    soroban.setValue(soroban.currentValue + 1);
    updateNumberDisplay(soroban.currentValue);
  });
  setupScrollButton('scroll-down', () => {
    soroban.setValue(soroban.currentValue - 1);
    updateNumberDisplay(soroban.currentValue);
  });
});

// æ•°å­—è¡¨ç¤ºã®æ›´æ–°
function updateNumberDisplay(val) {
  const el = document.getElementById('answer-display');
  if (el) el.textContent = val.toString();
}

// é€£ç¶šã‚¯ãƒªãƒƒã‚¯ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
function setupScrollButton(id, action) {
  const btn = document.getElementById(id);
  if (!btn) return;
  let timer, interval;
  
  const start = (e) => {
    e.preventDefault(); action();
    timer = setTimeout(() => {
      interval = setInterval(action, 100);
    }, 500);
  };
  const stop = () => {
    clearTimeout(timer); clearInterval(interval);
  };

  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchstart', start);
  btn.addEventListener('mouseup', stop);
  btn.addEventListener('mouseleave', stop);
  btn.addEventListener('touchend', stop);
}
</script>

<style>
  /* å…±é€šè¨­å®š */
  .test-screen {
    width: 100%;
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .game-panel {
    flex: 1;
    padding: 10px;
    display: flex;
    flex-direction: column;
    background: #faf8f5;
  }

  .game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
    flex-shrink: 0;
  }

  .btn-back {
    border: none;
    border-radius: 12px;
    padding: 8px 16px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    background: #8b7e71;
    color: #ffffff;
    border: 2px solid #6b5f52;
  }

  .instruction-box {
    text-align: center;
    margin-bottom: 5px;
    flex-shrink: 0;
  }
  .instruction {
    font-size: 0.9rem;
    margin: 0;
    color: var(--text-main);
  }

  /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šä¸Šä¸‹åˆ†å‰² */
  .layout-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    gap: 10px;
    overflow: hidden;
  }

  .feedback-area {
    display: none;
  }

  /* ãƒ¡ã‚¤ãƒ³ï¼šãã‚ã°ã‚“ã‚¨ãƒªã‚¢ */
  .main-area {
    display: flex;
    flex-direction: column;
    flex: 1;
    gap: 10px;
  }

  .abacus-area {
    flex: 1 1 50%;
    position: relative;
    display: flex;
    justify-content: center;
    width: 100%;
    min-height: 0;
  }

  .abacus-wrapper {
    width: 100%;
    height: 100%;
    max-width: 500px;
    display: flex; justify-content: center; align-items: center;
  }

  #abacus-display-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(#abacus-display-container svg) {
    max-width: 100%;
    max-height: 100%;
    display: block;
    /* ã‚¿ãƒƒãƒæ“ä½œç¦æ­¢ã‚’è§£é™¤ï¼ˆãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆæœ‰åŠ¹åŒ–ï¼‰ */
    pointer-events: auto; 
  }

  /* ä¸‹åŠåˆ†ï¼šæ“ä½œã‚¨ãƒªã‚¢ */
  .keypad-area {
    flex: 1 1 50%;
    display: flex;
    flex-direction: column;
    gap: 6px;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
    min-height: 0;
  }

  .answer-area {
    display: flex;
    gap: 5px;
    height: 50px;
    flex-shrink: 0;
  }

  .answer-display {
    flex: 1;
    background: #fff;
    border: 2px solid #f0e0c8;
    border-radius: 8px;
    font-size: 2rem;
    text-align: right;
    padding-right: 10px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    font-family: 'SorobanFont', sans-serif !important;
  }

  .scroll-buttons {
    display: flex;
    flex-direction: column;
    width: 40px;
    gap: 2px;
  }
  .scroll-btn {
    flex: 1;
    background: #f3e1d2;
    border: 1px solid #d4c4b0;
    border-radius: 4px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .keypad {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .keypad-row {
    flex: 1;
    display: flex;
    gap: 4px;
  }
  .key-btn {
    flex: 1;
    border: none;
    border-radius: 6px;
    background: #fff8e6;
    border-bottom: 3px solid #e0d0b8;
    font-size: 1.5rem;
    font-weight: bold;
    color: #4b3b30;
    touch-action: manipulation;
    font-family: 'SorobanFont', sans-serif !important;
  }
  .key-btn:active {
    transform: translateY(2px);
    border-bottom-width: 1px;
    background: #f3e1d2;
  }

  @media (min-width: 768px) {
    .main-area {
      flex-direction: row;
      align-items: center;
      gap: 20px;
    }
    .abacus-area, .keypad-area {
      flex: 1 1 50%;
      height: 500px;
    }
    .game-panel {
      max-width: 900px;
      margin: 0 auto;
      height: auto;
      border-radius: 16px;
      padding: 20px;
    }
    .test-screen {
      height: auto;
      min-height: 100vh;
      overflow: visible;
    }
  }
</style>
</BaseLayout>