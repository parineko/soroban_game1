---
import AbacusDisplay from "../components/AbacusDisplay.astro";
import BaseLayout from "../layouts/BaseLayout.astro";

// åˆæœŸå€¤ã¯0ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§æ›´æ–°ã•ã‚Œã‚‹ï¼‰
const initialValue = 0;
const initialDigits = 4;
---

<BaseLayout>
<div style="padding: 20px; background: white; min-height: 100vh;">
  <div style="text-align: center; margin-bottom: 20px;">
    <h1 style="font-size: 2rem; margin-bottom: 10px;">ãã‚ã°ã‚“å…¥åŠ›ãƒ†ã‚¹ãƒˆ</h1>
    <a href="/" style="display: inline-block; padding: 8px 16px; background: #f4e5d6; color: #333; text-decoration: none; border-radius: 999px; font-size: 0.9rem; transition: background 0.2s;">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
  </div>
  
  <div style="display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 40px;">
    <!-- ãã‚ã°ã‚“è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆä¸Šï¼‰ -->
    <div style="text-align: center;">
      <div id="abacusContainer">
        <AbacusDisplay value={initialValue} digits={initialDigits} />
      </div>
    </div>
    
    <!-- å…¥åŠ›æ¬„ï¼ˆä¸‹ï¼‰ -->
    <div style="text-align: center;">
      <label style="display: block; font-size: 1.2rem; margin-bottom: 10px; font-weight: bold;">
        4æ¡ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-9999):
      </label>
      <input
        id="numberInput"
        type="number"
        min="0"
        max="9999"
        placeholder="0000"
        style="padding: 10px; font-size: 1.5rem; text-align: center; width: 200px; border: 2px solid #333; border-radius: 5px;"
      />
      <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">æ•°å­—ã‚’å…¥åŠ›ã™ã‚‹ã¨è‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã¾ã™</p>
    </div>
  </div>
</div>

<script>
  // AbacusDisplayã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§å†ç¾
  const rodX = [62, 184, 306, 428];
  const tamaWidth = 108;
  const tamaOffsetX = tamaWidth / 2;
  const upperRestY = 106;
  const upperActiveY = 141;
  const lowerRestY = 469;
  const lowerActiveStartY = 229;
  const lowerGap = 65;

  function getDigit(value, digits, col) {
    const str = value.toString().padStart(digits, "0");
    const digitArray = Array.from(str).map(char => parseInt(char, 10));
    const rightToLeftIndex = 3 - col;
    const arrayIndex = digits - 1 - rightToLeftIndex;
    return arrayIndex >= 0 && arrayIndex < digitArray.length ? digitArray[arrayIndex] : 0;
  }

  function getUpperY(value, digits, col) {
    const digit = getDigit(value, digits, col);
    return digit >= 5 ? upperActiveY : upperRestY;
  }

  function getLowerY(value, digits, col, row) {
    const digit = getDigit(value, digits, col);
    const ones = digit % 5;
    if (row < ones) {
      return lowerActiveStartY + row * lowerGap;
    }
    return lowerRestY - (3 - row) * lowerGap;
  }

  function updateAbacus(value) {
    const digits = value.toString().length;
    const maxDigits = Math.max(digits, 4);

    // ç‰ã®ä½ç½®ã‚’æ›´æ–°
    for (let col = 0; col < 4; col++) {
      // ä¸Šç‰
      const upperBead = document.querySelector(`.tama.upper.U${col}`);
      if (upperBead) {
        const y = getUpperY(value, maxDigits, col);
        upperBead.style.left = `${rodX[col] - tamaOffsetX}px`;
        upperBead.style.top = `${y}px`;
      }

      // ä¸‹ç‰
      for (let row = 0; row < 4; row++) {
        const lowerBead = document.querySelector(`.tama.lower.L${col}_${row}`);
        if (lowerBead) {
          const y = getLowerY(value, maxDigits, col, row);
          lowerBead.style.left = `${rodX[col] - tamaOffsetX}px`;
          lowerBead.style.top = `${y}px`;
        }
      }
    }
  }

  // DOMContentLoadedã‚’å¾…ã¤
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('numberInput');
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸå€¤ã‚’è¨­å®š
    const urlParams = new URLSearchParams(window.location.search);
    const urlValue = urlParams.get('value');
    const initialValue = urlValue ? parseInt(urlValue) || 0 : 0;
    
    console.log('[Client] Initial URL value:', urlValue, 'Initial value:', initialValue);
    
    if (input) {
      input.value = initialValue.toString();
    }
    
    // åˆæœŸå€¤ã‚’ãã‚ã°ã‚“ã«åæ˜ 
    updateAbacus(initialValue);
    
    // å…¥åŠ›æ¬„ã®å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ¢ãƒ‹ã‚¿ãƒ¼
    input?.addEventListener('input', (e) => {
      const inputValue = input.value.trim();
      if (inputValue === '') {
        updateAbacus(0);
        return;
      }
      const value = parseInt(inputValue, 10);
      if (!isNaN(value)) {
        const clampedValue = Math.max(0, Math.min(9999, value));
        // ãã‚ã°ã‚“ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°
        updateAbacus(clampedValue);
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰
        const baseUrl = window.location.origin + window.location.pathname;
        window.history.pushState({}, '', `${baseUrl}?value=${clampedValue}`);
      }
    });
  });
</script>

<style>
  :global(body) {
    margin: 0;
    padding: 0;
    background: white;
  }
</style>
</div>
</BaseLayout>

