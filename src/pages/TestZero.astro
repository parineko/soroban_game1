---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout showHeader={false}>
<div class="screen test-screen">
  <div class="panel game-panel">
    <div class="game-header">
      <div class="game-header-left">
        <p class="badge">ãã‚ã°ã‚“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ğŸ’»</p>
      </div>
      <div class="game-header-right">
        <button class="btn-back" onclick="window.location.href='/'" aria-label="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹">ã‚‚ã©ã‚‹ ğŸ </button>
      </div>
    </div>

    <div class="instruction-box">
      <p class="instruction" id="instruction-text">
        ã™ã†ã˜ã‚’ ã„ã‚Œã¦ ãã‚ã°ã‚“ã® ãŸã¾ã‚’ ã†ã”ã‹ã—ã¦ã¿ã‚ˆã† âœ¨
      </p>
    </div>

    <div class="layout-wrapper">
      <div class="feedback-area">
        <div id="countdown" class="countdown" style="display: none;"></div>
        <div id="feedback" class="feedback"></div>
      </div>

      <div class="main-area">
        <div id="abacus-area" class="abacus-area">
          <div class="abacus-wrapper">
            <div id="abacus-display-container"></div>
          </div>
        </div>

        <div class="keypad-area">
          <div class="answer-area">
            <div id="answer-display" class="answer-display">0</div>
            <div class="scroll-buttons">
              <button class="scroll-btn" id="scroll-up" aria-label="æ•°å­—ã‚’å¢—ã‚„ã™">â–²</button>
              <button class="scroll-btn" id="scroll-down" aria-label="æ•°å­—ã‚’æ¸›ã‚‰ã™">â–¼</button>
            </div>
          </div>

          <div class="keypad">
            <div class="keypad-row">
              <button class="key-btn" data-key="7" aria-label="7">7</button>
              <button class="key-btn" data-key="8" aria-label="8">8</button>
              <button class="key-btn" data-key="9" aria-label="9">9</button>
            </div>
            <div class="keypad-row">
              <button class="key-btn" data-key="4" aria-label="4">4</button>
              <button class="key-btn" data-key="5" aria-label="5">5</button>
              <button class="key-btn" data-key="6" aria-label="6">6</button>
            </div>
            <div class="keypad-row">
              <button class="key-btn" data-key="1" aria-label="1">1</button>
              <button class="key-btn" data-key="2" aria-label="2">2</button>
              <button class="key-btn" data-key="3" aria-label="3">3</button>
            </div>
            <div class="keypad-row">
              <button class="key-btn" data-key="0" aria-label="0">0</button>
              <button class="key-btn" data-key="del" aria-label="ã‘ã™">ã‘ã™</button>
              <button class="key-btn" data-key="clear" aria-label="ã‚¯ãƒªã‚¢">ã‚¯ãƒªã‚¢</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // åˆæœŸå€¤
  const INITIAL_VALUE = 0;
  const INITIAL_DIGITS = 4;

  function getElementSafely(id) {
    const el = document.getElementById(id);
    if (!el) {
      console.error(`Element not found: ${id}`);
      return null;
    }
    return el;
  }

  function validateDigit(num) {
    const n = Number(num);
    if (isNaN(n) || n < 0 || n > 9) {
      return null;
    }
    return n;
  }

  // --- åº§æ¨™è¨­å®šï¼ˆã‚¹ãƒãƒ›å¯¾å¿œãƒ»ç²¾å¯†ç‰ˆï¼‰ ---
  
  // æ£’ã®ä¸­å¿ƒXåº§æ¨™ (%)
  const ROD_X = [11.6, 36.2, 61.2, 85.8];

  // ç‰ã®å¹…ã¨ã‚ªãƒ•ã‚»ãƒƒãƒˆ (%)
  const TAMA_WIDTH = 20.0; 
  const TAMA_OFFSET = 9.0; // width / 2

  // Yåº§æ¨™è¨­å®š (%)
  const Y = {
    upperRest: 4.0,
    upperActive: 13.0,
    lowerRest: 83.0,
    lowerActiveStart: 30.5,
    lowerGap: 13
  };

  // æ¡ã®è¨ˆç®—
  function getDigit(value, digits, col) {
    const str = value.toString().padStart(digits, "0");
    const digitArray = Array.from(str).map(char => parseInt(char, 10));
    const rightToLeftIndex = 3 - col;
    const arrayIndex = digits - 1 - rightToLeftIndex;
    return arrayIndex >= 0 && arrayIndex < digitArray.length ? digitArray[arrayIndex] : 0;
  }

  // Yåº§æ¨™å–å¾—ï¼ˆ%ï¼‰
  function getUpperY(value, digits, col) {
    const digit = getDigit(value, digits, col);
    return digit >= 5 ? Y.upperActive : Y.upperRest;
  }

  function getLowerY(value, digits, col, row) {
    const digit = getDigit(value, digits, col);
    const ones = digit % 5;
    if (row < ones) {
      return Y.lowerActiveStart + row * Y.lowerGap;
    }
    return Y.lowerRest - (3 - row) * Y.lowerGap;
  }

  // ãã‚ã°ã‚“ç”Ÿæˆ
  function createAbacusDisplay(value, digits) {
    const container = getElementSafely('abacus-display-container');
    if (!container) return;
    
    container.innerHTML = '';
    const maxDigits = Math.max(digits, 4);

    const abacusBase = document.createElement('div');
    abacusBase.className = 'abacus-base';
    abacusBase.style.cssText = 'position: relative; width: 100%; height: auto; margin: 0 auto; max-width: 500px;';
    
    const dodai = document.createElement('img');
    dodai.src = '/images/dodai.png';
    dodai.alt = 'ãã‚ã°ã‚“ã®åœŸå°';
    dodai.className = 'dodai';
    dodai.style.cssText = 'display: block; width: 100%; height: auto;';
    abacusBase.appendChild(dodai);

    for (let col = 0; col < 4; col++) {
      // ä¸Šç‰
      const upperBead = document.createElement('img');
      upperBead.src = '/images/tama.png';
      upperBead.className = 'tama upper U' + col;
      const upperY = getUpperY(value, maxDigits, col);
      const upperLeft = ROD_X[col] - TAMA_OFFSET;
      upperBead.style.cssText = `position: absolute; left: ${upperLeft}%; top: ${upperY}%; width: ${TAMA_WIDTH}%; height: auto; z-index: 10; transition: top 0.2s ease-out;`;
      abacusBase.appendChild(upperBead);

      // ä¸‹ç‰
      for (let row = 0; row < 4; row++) {
        const lowerBead = document.createElement('img');
        lowerBead.src = '/images/tama.png';
        lowerBead.className = 'tama lower L' + col + '_' + row;
        const lowerY = getLowerY(value, maxDigits, col, row);
        const lowerLeft = ROD_X[col] - TAMA_OFFSET;
        lowerBead.style.cssText = `position: absolute; left: ${lowerLeft}%; top: ${lowerY}%; width: ${TAMA_WIDTH}%; height: auto; z-index: 10; transition: top 0.2s ease-out;`;
        abacusBase.appendChild(lowerBead);
      }
    }
    container.appendChild(abacusBase);
  }

  // è¡¨ç¤ºæ›´æ–°
  function updateAbacusDisplay(value, digits) {
    const maxDigits = Math.max(digits, 4);
    for (let col = 0; col < 4; col++) {
      const upperBead = document.querySelector(`.tama.upper.U${col}`);
      if (upperBead) {
        const y = getUpperY(value, maxDigits, col);
        upperBead.style.top = `${y}%`;
      }
      for (let row = 0; row < 4; row++) {
        const lowerBead = document.querySelector(`.tama.lower.L${col}_${row}`);
        if (lowerBead) {
          const y = getLowerY(value, maxDigits, col, row);
          lowerBead.style.top = `${y}%`;
        }
      }
    }
  }

  let currentValue = INITIAL_VALUE;
  let continuousChangeTimer = null;
  let continuousChangeInterval = null;

  function incrementAnswer() {
    const newValue = Math.min(currentValue + 1, 9999);
    currentValue = newValue;
    updateDisplay();
  }

  function decrementAnswer() {
    const newValue = Math.max(currentValue - 1, 0);
    currentValue = newValue;
    updateDisplay();
  }

  function updateDisplay() {
    const answerDisplay = getElementSafely('answer-display');
    if (answerDisplay) {
      answerDisplay.textContent = currentValue.toString();
    }
    const digits = Math.max(currentValue.toString().length, 4);
    updateAbacusDisplay(currentValue, digits);
  }

  function startContinuousChange(buttonId) {
    stopContinuousChange();
    continuousChangeTimer = setTimeout(() => {
      continuousChangeInterval = setInterval(() => {
        if (buttonId === 'scroll-up') {
          incrementAnswer();
        } else {
          decrementAnswer();
        }
      }, 100);
    }, 500);
  }

  function stopContinuousChange() {
    if (continuousChangeTimer) {
      clearTimeout(continuousChangeTimer);
      continuousChangeTimer = null;
    }
    if (continuousChangeInterval) {
      clearInterval(continuousChangeInterval);
      continuousChangeInterval = null;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    createAbacusDisplay(INITIAL_VALUE, INITIAL_DIGITS);

    document.body.addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button) return;
      const key = button.getAttribute('data-key');
      if (!key) return;

      event.preventDefault();

      if (key === 'del') {
        const str = currentValue.toString();
        if (str.length > 1) {
          currentValue = parseInt(str.slice(0, -1), 10) || 0;
        } else {
          currentValue = 0;
        }
        updateDisplay();
      } else if (key === 'clear') {
        currentValue = 0;
        updateDisplay();
      } else if (/^[0-9]$/.test(key)) {
        const validatedDigit = validateDigit(key);
        if (validatedDigit === null) return;
        
        if (currentValue === 0) {
          currentValue = validatedDigit;
        } else {
          const newValue = currentValue * 10 + validatedDigit;
          if (newValue <= 9999) {
            currentValue = newValue;
          }
        }
        updateDisplay();
      }
    });

    const scrollUpBtn = getElementSafely('scroll-up');
    const scrollDownBtn = getElementSafely('scroll-down');

    if (scrollUpBtn) {
      scrollUpBtn.addEventListener('mousedown', (e) => { e.preventDefault(); incrementAnswer(); startContinuousChange('scroll-up'); });
      scrollUpBtn.addEventListener('mouseup', stopContinuousChange);
      scrollUpBtn.addEventListener('mouseleave', stopContinuousChange);
      scrollUpBtn.addEventListener('touchstart', (e) => { e.preventDefault(); incrementAnswer(); startContinuousChange('scroll-up'); });
      scrollUpBtn.addEventListener('touchend', stopContinuousChange);
    }

    if (scrollDownBtn) {
      scrollDownBtn.addEventListener('mousedown', (e) => { e.preventDefault(); decrementAnswer(); startContinuousChange('scroll-down'); });
      scrollDownBtn.addEventListener('mouseup', stopContinuousChange);
      scrollDownBtn.addEventListener('mouseleave', stopContinuousChange);
      scrollDownBtn.addEventListener('touchstart', (e) => { e.preventDefault(); decrementAnswer(); startContinuousChange('scroll-down'); });
      scrollDownBtn.addEventListener('touchend', stopContinuousChange);
    }
  });
</script>

<style>
  /* å…±é€šè¨­å®š */
  .test-screen {
    width: 100%;
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .game-panel {
    flex: 1;
    padding: 10px;
    display: flex;
    flex-direction: column;
    background: #faf8f5;
  }

  .game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
    flex-shrink: 0;
  }

  .btn-back {
    border: none;
    border-radius: 12px;
    padding: 8px 16px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    background: #8b7e71;
    color: #ffffff;
    border: 2px solid #6b5f52;
  }

  .instruction-box {
    text-align: center;
    margin-bottom: 5px;
    flex-shrink: 0;
  }
  .instruction {
    font-size: 0.9rem;
    margin: 0;
    color: var(--text-main);
  }

  /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šä¸Šä¸‹åˆ†å‰² */
  .layout-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    gap: 10px;
    overflow: hidden;
  }

  .feedback-area {
    display: none;
  }

  /* ãƒ¡ã‚¤ãƒ³ï¼šãã‚ã°ã‚“ã‚¨ãƒªã‚¢ */
  .main-area {
    display: flex;
    flex-direction: column;
    flex: 1;
    gap: 10px;
  }

  .abacus-area {
    /* â˜…ä¿®æ­£: æ¯”ç‡ã‚’3ï¼ˆãã‚ã°ã‚“ï¼‰ã«è¨­å®šã€‚ã“ã‚Œã§ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ãªã‚Šã¾ã™ */
    flex: 1;
    position: relative;
    display: flex;
    justify-content: center;
    width: 100%;
    min-height: 0;
  }

  .abacus-wrapper {
    width: 100%;
    height: 100%;
    max-width: 500px;
    border: 2px solid #d4c4b0;
    border-radius: 8px;
    background: #fff;
  }

  #abacus-display-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* ä¸‹åŠåˆ†ï¼šæ“ä½œã‚¨ãƒªã‚¢ */
  .keypad-area {
    /* â˜…ä¿®æ­£: æ¯”ç‡ã‚’4ï¼ˆãƒ†ãƒ³ã‚­ãƒ¼ï¼‰ã«è¨­å®šã€‚ */
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
    min-height: 0;
  }

  .answer-area {
    display: flex;
    gap: 5px;
    height: 50px;
    flex-shrink: 0;
  }

  .answer-display {
    flex: 1;
    background: #fff;
    border: 2px solid #f0e0c8;
    border-radius: 8px;
    font-size: 2rem;
    text-align: right;
    padding-right: 10px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }

  .scroll-buttons {
    display: flex;
    flex-direction: column;
    width: 40px;
    gap: 2px;
  }
  .scroll-btn {
    flex: 1;
    background: #f3e1d2;
    border: 1px solid #d4c4b0;
    border-radius: 4px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .keypad {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .keypad-row {
    flex: 1;
    display: flex;
    gap: 4px;
  }
  .key-btn {
    flex: 1;
    border: none;
    border-radius: 6px;
    background: #fff8e6;
    border-bottom: 3px solid #e0d0b8;
    font-size: 1.5rem;
    font-weight: bold;
    color: #4b3b30;
    touch-action: manipulation;
  }
  .key-btn:active {
    transform: translateY(2px);
    border-bottom-width: 1px;
    background: #f3e1d2;
  }

  /* PCç”»é¢å‘ã‘ã®èª¿æ•´ */
  @media (min-width: 768px) {
    .main-area {
      flex-direction: row;
      align-items: flex-start;
      gap: 20px;
    }
    .abacus-area, .keypad-area {
      flex: 1;
      height: 500px;
    }
    .game-panel {
      max-width: 900px;
      margin: 0 auto;
      height: auto;
      border-radius: 16px;
      padding: 20px;
    }
    .test-screen {
      height: auto;
      min-height: 100vh;
      overflow: visible;
    }
  }
</style>
</BaseLayout>