---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout>
<div class="test-screen" style="padding: 20px; min-height: 100vh;">
  <div style="text-align: center; margin-bottom: 20px;">
    <h1 style="font-size: 2rem; margin-bottom: 10px;">„Åù„Çç„Å∞„ÇìÂÖ•Âäõ„ÉÜ„Çπ„Éà</h1>
    <a href="/" class="btn-back" style="display: inline-block; padding: 8px 16px; background: #8b7e71; color: #ffffff; text-decoration: none; border-radius: 12px; font-size: 0.9rem; transition: all 0.15s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); border: 2px solid #6b5f52;">üè† „Éõ„Éº„É†„Å´Êàª„Çã</a>
  </div>

  <div class="abacus-and-controls">
    <!-- Â∑¶ÂÅ¥Ôºö„Åù„Çç„Å∞„Çì„Ç®„É™„Ç¢ -->
    <div id="abacus-area" class="abacus-area">
      <div class="abacus-wrapper">
        <div id="abacus-display-container"></div>
      </div>
    </div>

    <!-- Âè≥ÂÅ¥Ôºö„Ç≥„É≥„Éà„É≠„Éº„É´„Ç®„É™„Ç¢ -->
    <div class="control-area">
      <div class="answer-area">
        <div id="answer-display" class="answer-display">0</div>
        <div class="scroll-buttons">
          <button class="scroll-btn" id="scroll-up" aria-label="Êï∞Â≠ó„ÇíÂ¢ó„ÇÑ„Åô">‚ñ≤</button>
          <button class="scroll-btn" id="scroll-down" aria-label="Êï∞Â≠ó„ÇíÊ∏õ„Çâ„Åô">‚ñº</button>
        </div>
      </div>

      <div class="keypad">
        <div class="keypad-row">
          <button class="key-btn" data-key="7">7</button>
          <button class="key-btn" data-key="8">8</button>
          <button class="key-btn" data-key="9">9</button>
        </div>
        <div class="keypad-row">
          <button class="key-btn" data-key="4">4</button>
          <button class="key-btn" data-key="5">5</button>
          <button class="key-btn" data-key="6">6</button>
        </div>
        <div class="keypad-row">
          <button class="key-btn" data-key="1">1</button>
          <button class="key-btn" data-key="2">2</button>
          <button class="key-btn" data-key="3">3</button>
        </div>
        <div class="keypad-row">
          <button class="key-btn" data-key="0">0</button>
          <button class="key-btn" data-key="del">„Åë„Åô</button>
          <button class="key-btn" data-key="clear">„ÇØ„É™„Ç¢</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ÂàùÊúüÂÄ§Ôºà„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„ÅßÂÆöÁæ©Ôºâ
  const INITIAL_VALUE = 0;
  const INITIAL_DIGITS = 4;

  // DOMË¶ÅÁ¥†„ÇíÂÆâÂÖ®„Å´ÂèñÂæó„Åô„Çã
  function getElementSafely(id) {
    const el = document.getElementById(id);
    if (!el) {
      console.error(`Element not found: ${id}`);
      return null;
    }
    return el;
  }

  // Êï∞Â≠ó„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ôºà0-9„ÅÆ„ÅøÔºâ
  function validateDigit(num) {
    const n = Number(num);
    if (isNaN(n) || n < 0 || n > 9) {
      console.warn("‰∏çÊ≠£„Å™ÂÖ•Âäõ:", num);
      return null;
    }
    return n;
  }

  // ÁîªÂÉèË™≠„ÅøËæº„Åø„Ç®„É©„ÉºÂá¶ÁêÜ„ÇíË®≠ÂÆö
  function setupImageErrorHandler(img) {
    img.onerror = () => {
      console.error("ÁîªÂÉèË™≠„ÅøËæº„Åø„Å´Â§±Êïó:", img.src);
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁîªÂÉè„Åå„ÅÇ„Çå„Å∞Â∑Æ„ÅóÊõø„Åà„ÄÅÁÑ°„Åë„Çå„Å∞ÁÑ°Ë¶ñ
    };
  }

  // gameController.js„Å®Âêå„ÅòÂ∫ßÊ®ôË®≠ÂÆö
  const rodX = [62, 184, 306, 428];
  const tamaWidth = 108;
  const tamaOffsetX = tamaWidth / 2;
  const upperRestY = 106;
  const upperActiveY = 141;
  const lowerRestY = 469;
  const lowerActiveStartY = 229;
  const lowerGap = 65;

  function getDigit(value, digits, col) {
    const str = value.toString().padStart(digits, "0");
    const digitArray = Array.from(str).map(char => parseInt(char, 10));
    const rightToLeftIndex = 3 - col;
    const arrayIndex = digits - 1 - rightToLeftIndex;
    return arrayIndex >= 0 && arrayIndex < digitArray.length ? digitArray[arrayIndex] : 0;
  }

  function getUpperY(value, digits, col) {
    const digit = getDigit(value, digits, col);
    return digit >= 5 ? upperActiveY : upperRestY;
  }

  function getLowerY(value, digits, col, row) {
    const digit = getDigit(value, digits, col);
    const ones = digit % 5;
    if (row < ones) {
      return lowerActiveStartY + row * lowerGap;
    }
    return lowerRestY - (3 - row) * lowerGap;
  }

  function createAbacusDisplay(value, digits) {
    const container = getElementSafely('abacus-display-container');
    if (!container) return;

    // Êó¢Â≠ò„ÅÆ„Åù„Çç„Å∞„Çì„ÇíÂâäÈô§
    container.innerHTML = '';

    // gameController.js„Å®Âêå„Åò„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
    const maxDigits = Math.max(digits, 4);
    const abacusBase = document.createElement('div');
    abacusBase.className = 'abacus-base';
    abacusBase.style.cssText = 'position: relative; width: 500px; height: 700px; overflow: hidden; margin-top: -75px; margin-bottom: -75px;';
    
    // ÂúüÂè∞ÁîªÂÉè
    const dodai = document.createElement('img');
    dodai.src = '/images/dodai.png';
    dodai.alt = '„Åù„Çç„Å∞„Çì„ÅÆÂúüÂè∞';
    dodai.className = 'dodai';
    dodai.style.cssText = 'width: 100%; height: 100%; display: block;';
    setupImageErrorHandler(dodai);
    abacusBase.appendChild(dodai);

    // Áéâ„ÇíÈÖçÁΩÆÔºàgameController.js„Å®Âêå„Åò„Çπ„Çø„Ç§„É´Ôºâ
    for (let col = 0; col < 4; col++) {
      // ‰∏äÁéâÔºà‰∫îÁéâÔºâ
      const upperBead = document.createElement('img');
      upperBead.src = '/images/tama.png';
      upperBead.alt = '„Åù„Çç„Å∞„Çì„ÅÆÁéâÔºà‰∏äÔºâ';
      upperBead.setAttribute('class', 'tama upper U' + col);
      upperBead.setAttribute('data-col', col);
      upperBead.setAttribute('data-type', 'upper');
      const upperY = getUpperY(value, maxDigits, col);
      const upperLeft = rodX[col] - tamaOffsetX;
      upperBead.style.cssText = 'position: absolute; left: ' + upperLeft + 'px; top: ' + upperY + 'px; width: 108px; height: 70px; opacity: 1; pointer-events: none; z-index: 10; transition: top 0.3s ease;';
      setupImageErrorHandler(upperBead);
      abacusBase.appendChild(upperBead);

      // ‰∏ãÁéâÔºà‰∏ÄÁéâÔºâ
      for (let row = 0; row < 4; row++) {
        const lowerBead = document.createElement('img');
        lowerBead.src = '/images/tama.png';
        lowerBead.alt = '„Åù„Çç„Å∞„Çì„ÅÆÁéâÔºà‰∏ãÔºâ';
        lowerBead.setAttribute('class', 'tama lower L' + col + '_' + row);
        lowerBead.setAttribute('data-col', col);
        lowerBead.setAttribute('data-row', row);
        lowerBead.setAttribute('data-type', 'lower');
        const lowerY = getLowerY(value, maxDigits, col, row);
        const lowerLeft = rodX[col] - tamaOffsetX;
        lowerBead.style.cssText = 'position: absolute; left: ' + lowerLeft + 'px; top: ' + lowerY + 'px; width: 108px; height: 70px; opacity: 1; pointer-events: none; z-index: 10; transition: top 0.3s ease;';
        setupImageErrorHandler(lowerBead);
        abacusBase.appendChild(lowerBead);
      }
    }

    container.appendChild(abacusBase);
  }

  function updateAbacusDisplay(value, digits) {
    const maxDigits = Math.max(digits, 4);
    for (let col = 0; col < 4; col++) {
      // ‰∏äÁéâ
      const upperBead = document.querySelector(`.tama.upper.U${col}`);
      if (upperBead) {
        const y = getUpperY(value, maxDigits, col);
        upperBead.style.top = `${y}px`;
      }

      // ‰∏ãÁéâ
      for (let row = 0; row < 4; row++) {
        const lowerBead = document.querySelector(`.tama.lower.L${col}_${row}`);
        if (lowerBead) {
          const y = getLowerY(value, maxDigits, col, row);
          lowerBead.style.top = `${y}px`;
        }
      }
    }
  }

  let currentValue = INITIAL_VALUE;
  let continuousChangeTimer = null;
  let continuousChangeInterval = null;

  function incrementAnswer() {
    const newValue = Math.min(currentValue + 1, 9999);
    currentValue = newValue;
    updateDisplay();
  }

  function decrementAnswer() {
    const newValue = Math.max(currentValue - 1, 0);
    currentValue = newValue;
    updateDisplay();
  }

  function updateDisplay() {
    const answerDisplay = getElementSafely('answer-display');
    if (answerDisplay) {
      answerDisplay.textContent = currentValue.toString();
    }
    
    const digits = Math.max(currentValue.toString().length, 4);
    updateAbacusDisplay(currentValue, digits);
  }

  function startContinuousChange(buttonId) {
    stopContinuousChange();
    continuousChangeTimer = setTimeout(() => {
      continuousChangeInterval = setInterval(() => {
        if (buttonId === 'scroll-up') {
          incrementAnswer();
        } else {
          decrementAnswer();
        }
      }, 100);
    }, 500);
  }

  function stopContinuousChange() {
    if (continuousChangeTimer) {
      clearTimeout(continuousChangeTimer);
      continuousChangeTimer = null;
    }
    if (continuousChangeInterval) {
      clearInterval(continuousChangeInterval);
      continuousChangeInterval = null;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // ÂàùÊúü„Åù„Çç„Å∞„ÇìË°®Á§∫
    createAbacusDisplay(INITIAL_VALUE, INITIAL_DIGITS);

    // „Ç≠„Éº„Éë„ÉÉ„ÉâÂá¶ÁêÜ
    document.body.addEventListener('click', (event) => {
      const button = event.target.closest('button');
      if (!button) return;

      const key = button.getAttribute('data-key');
      if (!key) return;

      event.preventDefault();

      if (key === 'del') {
        const str = currentValue.toString();
        if (str.length > 1) {
          currentValue = parseInt(str.slice(0, -1), 10) || 0;
        } else {
          currentValue = 0;
        }
        updateDisplay();
      } else if (key === 'clear') {
        currentValue = 0;
        updateDisplay();
      } else if (/^[0-9]$/.test(key)) {
        const validatedDigit = validateDigit(key);
        if (validatedDigit === null) {
          return;
        }
        if (currentValue === 0) {
          currentValue = validatedDigit;
        } else {
          const newValue = currentValue * 10 + validatedDigit;
          if (newValue <= 9999) {
            currentValue = newValue;
          }
        }
        updateDisplay();
      }
    });

    // ‰∏ä‰∏ã„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
    const scrollUpBtn = getElementSafely('scroll-up');
    const scrollDownBtn = getElementSafely('scroll-down');

    if (scrollUpBtn) {
      scrollUpBtn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        incrementAnswer();
        startContinuousChange('scroll-up');
      });
      scrollUpBtn.addEventListener('mouseup', stopContinuousChange);
      scrollUpBtn.addEventListener('mouseleave', stopContinuousChange);
      scrollUpBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        incrementAnswer();
        startContinuousChange('scroll-up');
      });
      scrollUpBtn.addEventListener('touchend', stopContinuousChange);
      scrollUpBtn.addEventListener('touchcancel', stopContinuousChange);
    }

    if (scrollDownBtn) {
      scrollDownBtn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        decrementAnswer();
        startContinuousChange('scroll-down');
      });
      scrollDownBtn.addEventListener('mouseup', stopContinuousChange);
      scrollDownBtn.addEventListener('mouseleave', stopContinuousChange);
      scrollDownBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        decrementAnswer();
        startContinuousChange('scroll-down');
      });
      scrollDownBtn.addEventListener('touchend', stopContinuousChange);
      scrollDownBtn.addEventListener('touchcancel', stopContinuousChange);
    }
  });
</script>

<style>
  .test-screen {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* GameScreen„Å®Âêå„Åò2„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„Éà */
  .abacus-and-controls {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    width: 100%;
    gap: 32px;
    margin: 20px 0;
    min-height: 700px;
  }

  .abacus-area {
    width: 500px;
    flex-shrink: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .abacus-wrapper {
    width: 500px;
    height: 700px;
    position: relative;
    border: 2px solid #d4c4b0;
    border-radius: 12px;
    background: #faf8f5;
    overflow: hidden;
  }

  #abacus-display-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .control-area {
    width: auto;
    flex: none;
    min-width: 300px;
    max-width: 350px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: stretch;
    justify-content: center;
  }

  .answer-area {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
  }

  .answer-display {
    flex: 1;
    min-height: 100px;
    max-height: 200px;
    border-radius: 12px;
    background: #ffffff;
    border: 3px solid #d4c4b0;
    padding: 20px 24px;
    font-size: 2.5rem;
    font-weight: bold;
    color: #333;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    text-align: right;
    overflow-y: auto;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .scroll-buttons {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-left: 8px;
  }

  .scroll-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: 1px solid #6b5f52;
    background: #8b7e71;
    color: #ffffff;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s ease;
  }

  .scroll-btn:hover {
    background: #6b5f52;
  }

  .keypad {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
  }

  .keypad-row {
    display: flex;
    gap: 12px;
    width: 100%;
  }

  .key-btn {
    flex: 1;
    aspect-ratio: 1;
    padding: 0;
    border-radius: 12px;
    border: 2px solid #6b5f52;
    background: #f7ebdb;
    color: #333;
    font-size: 1.8rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    min-width: 0;
    max-width: 100%;
  }

  .key-btn:hover {
    background: #e8d9c5;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .key-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .btn-back:hover {
    background: #6b5f52;
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);
  }

  .btn-back:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }
</style>
</BaseLayout>
