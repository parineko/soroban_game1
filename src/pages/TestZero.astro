---
// TestZero.astro
// å®Œå…¨ã‚¹ãƒãƒ›ç‰¹åŒ–ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆãƒ†ãƒ³ã‚­ãƒ¼æœ€å¤§åŒ–ï¼‰
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout showHeader={false}>
<div class="screen test-screen">
  <div class="panel game-panel">
    <div class="game-header">
      <div class="game-header-left">
        <p class="badge">ãã‚ã°ã‚“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ ğŸ’»</p>
      </div>
      <div class="game-header-right">
        <button class="btn-back" onclick="window.location.href='/'" aria-label="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹">ã‚‚ã©ã‚‹ ğŸ </button>
      </div>
    </div>

    <div class="instruction-box">
      <p class="instruction" id="instruction-text">
        ãŸã¾ã‚’ ã‚¿ãƒƒãƒã™ã‚‹ã‹ ã™ã†ã˜ã‚’ ã„ã‚Œã¦ ã‚ãã‚“ã§ã¿ã¦ã­ âœ¨
      </p>
    </div>

    <div class="layout-wrapper">
      
      <div id="abacus-area" class="abacus-area">
        <div class="abacus-wrapper">
          <div id="abacus-display-container"></div>
        </div>
      </div>

      <div class="keypad-area">
        <div class="answer-area">
          <div id="answer-display" class="answer-display">0</div>
          <div class="scroll-buttons">
            <button class="scroll-btn" id="scroll-up" aria-label="æ•°å­—ã‚’å¢—ã‚„ã™">â–²</button>
            <button class="scroll-btn" id="scroll-down" aria-label="æ•°å­—ã‚’æ¸›ã‚‰ã™">â–¼</button>
          </div>
        </div>

        <div class="keypad">
          <div class="keypad-row">
            <button class="key-btn" data-key="7">7</button>
            <button class="key-btn" data-key="8">8</button>
            <button class="key-btn" data-key="9">9</button>
          </div>
          <div class="keypad-row">
            <button class="key-btn" data-key="4">4</button>
            <button class="key-btn" data-key="5">5</button>
            <button class="key-btn" data-key="6">6</button>
          </div>
          <div class="keypad-row">
            <button class="key-btn" data-key="1">1</button>
            <button class="key-btn" data-key="2">2</button>
            <button class="key-btn" data-key="3">3</button>
          </div>
          <div class="keypad-row">
            <button class="key-btn" data-key="0">0</button>
            <button class="key-btn action" data-key="del">ã‘ã™</button>
            <button class="key-btn action" data-key="clear">ã‚¯ãƒªã‚¢</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * SorobanEngine
 * ãã‚ã°ã‚“ã®æç”»ãƒ»æ“ä½œãƒ»çŠ¶æ…‹ç®¡ç†ã‚’è¡Œã†ã‚³ã‚¢ã‚¯ãƒ©ã‚¹
 */
class SorobanEngine {
  constructor(containerId, config, onChangeCallback) {
    this.container = document.getElementById(containerId);
    this.config = config;
    this.onChange = onChangeCallback; 
    this.currentValue = 0;
    this.digits = config.digits || 5;
    
    if (this.container) {
      this.init();
    }
  }

  init() {
    this.container.innerHTML = '';
    const C = this.config;
    const totalWidth = this.digits * C.widthPerDigit;
    const totalHeight = C.height;
    const ns = "http://www.w3.org/2000/svg";

    const svg = document.createElementNS(ns, "svg");
    svg.setAttribute("viewBox", `0 0 ${totalWidth} ${totalHeight}`);
    svg.style.width = "100%";
    svg.style.height = "100%";
    
    this.drawBackground(svg, ns, totalWidth, totalHeight);

    for (let col = 0; col < this.digits; col++) {
      const cx = (col * C.widthPerDigit) + (C.widthPerDigit / 2);
      const beadX = cx - (C.bead.width / 2);

      const upperBead = this.createBead(ns, beadX, C.y.upperRest, `upper-${col}`);
      upperBead.style.cursor = "pointer";
      upperBead.addEventListener('click', () => this.handleBeadClick(col, 'upper', 0));
      svg.appendChild(upperBead);

      for (let row = 0; row < 4; row++) {
        const lowerY = C.y.lowerBase + (row * C.y.lowerGap);
        const lowerBead = this.createBead(ns, beadX, lowerY, `lower-${col}-${row}`);
        lowerBead.style.cursor = "pointer";
        lowerBead.addEventListener('click', () => this.handleBeadClick(col, 'lower', row));
        svg.appendChild(lowerBead);
      }
    }
    this.container.appendChild(svg);
  }

  drawBackground(svg, ns, w, h) {
    const C = this.config;
    const createRect = (x, y, width, height, fill, stroke) => {
      const rect = document.createElementNS(ns, "rect");
      rect.setAttribute("x", x); rect.setAttribute("y", y);
      rect.setAttribute("width", width); rect.setAttribute("height", height);
      rect.setAttribute("fill", fill);
      if (stroke) {
        rect.setAttribute("stroke", stroke.color);
        rect.setAttribute("stroke-width", stroke.width);
      }
      return rect;
    };

    svg.appendChild(createRect(0, 0, w, 10, C.colors.frame));
    svg.appendChild(createRect(0, h - 10, w, 10, C.colors.frame));
    svg.appendChild(createRect(0, C.y.beam, w, 12, C.colors.beam, {color: C.colors.beamBorder, width: 1}));

    for(let i=0; i < this.digits; i++) {
      const cx = (i * C.widthPerDigit) + (C.widthPerDigit / 2);
      const rod = createRect(cx - 3, 10, 6, h - 20, C.colors.rod);
      svg.insertBefore(rod, svg.children[2]); 

      const onePlaceIdx = this.digits - 1;
      const thousandPlaceIdx = this.digits - 4;
      
      if (i === onePlaceIdx || i === thousandPlaceIdx) {
         const dot = document.createElementNS(ns, "circle");
         dot.setAttribute("cx", cx);
         dot.setAttribute("cy", C.y.beam + 6);
         dot.setAttribute("r", 3);
         dot.setAttribute("fill", C.colors.dot);
         svg.appendChild(dot);
      }
    }
  }

  createBead(ns, x, y, id) {
    const C = this.config;
    const img = document.createElementNS(ns, "image");
    img.setAttribute("href", C.bead.imgSrc);
    img.setAttribute("x", x);
    img.setAttribute("y", y);
    img.setAttribute("width", C.bead.width);
    img.setAttribute("height", C.bead.height);
    img.setAttribute("id", id);
    img.style.transition = "y 0.1s ease-out";
    return img;
  }

  handleBeadClick(col, type, row) {
    const currentDigitVal = this.getDigitValue(this.currentValue, col);
    let newDigitVal = currentDigitVal;

    if (type === 'upper') {
      if (currentDigitVal >= 5) newDigitVal -= 5;
      else newDigitVal += 5;
    } else {
      const currentOnes = currentDigitVal % 5;
      const clickedPos = row; 
      
      if (clickedPos < currentOnes) {
        newDigitVal = (currentDigitVal - currentOnes) + clickedPos;
      } else {
        newDigitVal = (currentDigitVal - currentOnes) + (clickedPos + 1);
      }
    }
    this.updateDigitValue(col, newDigitVal);
  }

  updateDigitValue(col, newDigitVal) {
    const strVal = this.currentValue.toString().padStart(this.digits, '0');
    const chars = strVal.split('');
    chars[col] = newDigitVal.toString();
    const newValue = parseInt(chars.join(''), 10);
    this.setValue(newValue);
    if (this.onChange) this.onChange(newValue);
  }

  getDigitValue(totalValue, col) {
    const str = totalValue.toString().padStart(this.digits, "0");
    return parseInt(str[col], 10);
  }

  setValue(value) {
    const maxVal = Math.pow(10, this.digits) - 1;
    this.currentValue = Math.min(Math.max(0, value), maxVal);
    this.render();
  }

  render() {
    const C = this.config;
    const strVal = this.currentValue.toString().padStart(this.digits, "0");

    for (let col = 0; col < this.digits; col++) {
      const digit = parseInt(strVal[col], 10);
      const upperBead = document.getElementById(`upper-${col}`);
      if (upperBead) {
        const isUpperActive = digit >= 5;
        upperBead.setAttribute("y", isUpperActive ? C.y.upperActive : C.y.upperRest);
      }
      const ones = digit % 5;
      for (let row = 0; row < 4; row++) {
        const lowerBead = document.getElementById(`lower-${col}-${row}`);
        if (lowerBead) {
          const isLowerActive = row < ones;
          let targetY;
          if (isLowerActive) {
            targetY = (C.y.lowerBase + (row * C.y.lowerGap)) + C.y.lowerActiveOffset;
          } else {
            targetY = C.y.lowerBase + (row * C.y.lowerGap);
          }
          lowerBead.setAttribute("y", targetY);
        }
      }
    }
  }
}

const CONFIG = {
  digits: 5,
  widthPerDigit: 60,
  height: 225, 
  colors: {
    frame: "#231815", rod: "#deb887", beam: "#e6e6e6", 
    beamBorder: "#231815", dot: "#000000"
  },
  bead: { width: 60, height: 32, imgSrc: "/images/tama.png" },
  y: {
    upperRest: 10, upperActive: 28, beam: 60,
    lowerBase: 91, lowerGap: 31, lowerActiveOffset: -19
  }
};

let soroban; 

document.addEventListener('DOMContentLoaded', () => {
  soroban = new SorobanEngine('abacus-display-container', CONFIG, (newValue) => {
    updateNumberDisplay(newValue);
  });
  soroban.setValue(0);

  document.body.addEventListener('click', (event) => {
    const button = event.target.closest('button');
    if (!button) return;
    const key = button.getAttribute('data-key');
    if (!key) return;

    event.preventDefault();
    let current = soroban.currentValue;

    if (key === 'del') {
      const str = current.toString();
      soroban.setValue(str.length > 1 ? parseInt(str.slice(0, -1), 10) : 0);
    } else if (key === 'clear') {
      soroban.setValue(0);
    } else if (/^[0-9]$/.test(key)) {
      const num = parseInt(key, 10);
      if (current === 0) soroban.setValue(num);
      else soroban.setValue(current * 10 + num);
    }
    updateNumberDisplay(soroban.currentValue);
  });

  setupScrollButton('scroll-up', () => {
    soroban.setValue(soroban.currentValue + 1);
    updateNumberDisplay(soroban.currentValue);
  });
  setupScrollButton('scroll-down', () => {
    soroban.setValue(soroban.currentValue - 1);
    updateNumberDisplay(soroban.currentValue);
  });
});

function updateNumberDisplay(val) {
  const el = document.getElementById('answer-display');
  if (el) el.textContent = val.toString();
}

function setupScrollButton(id, action) {
  const btn = document.getElementById(id);
  if (!btn) return;
  let timer, interval;
  
  const start = (e) => {
    e.preventDefault(); action();
    timer = setTimeout(() => {
      interval = setInterval(action, 100);
    }, 500);
  };
  const stop = () => {
    clearTimeout(timer); clearInterval(interval);
  };

  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchstart', start);
  btn.addEventListener('mouseup', stop);
  btn.addEventListener('mouseleave', stop);
  btn.addEventListener('touchend', stop);
}
</script>

<style>
  /* å…±é€šè¨­å®šï¼šã‚¹ãƒãƒ›ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
  .test-screen {
    width: 100%;
    /* ãƒãƒ¼å¯¾ç­– */
    height: 100dvh; 
    overflow: hidden; 
    display: flex;
    justify-content: center;
    background-color: #fcf8f2;
  }

  .game-panel {
    width: 100%;
    max-width: 600px; /* PCã§ã‚‚ã‚¹ãƒãƒ›å¹…ã«åˆ¶é™ */
    height: 100%;
    padding: 10px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    display: flex;
    flex-direction: column;
    background: #faf8f5;
    box-sizing: border-box;
  }

  /* PCã§è¡¨ç¤ºã™ã‚‹éš›ã€ãƒ‘ãƒãƒ«é¢¨ã«è¦‹ã›ã‚‹è¨­å®š */
  @media (min-width: 768px) {
    .game-panel {
      height: 95vh;
      margin-top: 2.5vh;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
  }

  .game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
    flex-shrink: 0;
  }

  .btn-back {
    border: none;
    border-radius: 12px;
    padding: 8px 16px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    background: #8b7e71;
    color: #ffffff;
    border: 2px solid #6b5f52;
  }

  .instruction-box {
    text-align: center;
    margin-bottom: 5px;
    flex-shrink: 0;
  }
  .instruction {
    font-size: 0.9rem;
    margin: 0;
    color: var(--text-main);
  }

  /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šä¸Šä¸‹åˆ†å‰² */
  .layout-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    gap: 10px;
    overflow: hidden;
  }

  /* ãƒ¡ã‚¤ãƒ³ï¼šãã‚ã°ã‚“ã‚¨ãƒªã‚¢ï¼ˆä¸Šéƒ¨40%ï¼‰ */
  .abacus-area {
    height: 40%; /* å›ºå®šæ¯”ç‡ */
    width: 100%;
    flex-shrink: 0;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .abacus-wrapper {
    width: 100%;
    height: 100%;
    max-width: 500px;
    display: flex; justify-content: center; align-items: center;
  }

  #abacus-display-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(#abacus-display-container svg) {
    width: 100%;
    height: 100%;
    display: block;
  }

  /* ä¸‹åŠåˆ†ï¼šãƒ†ãƒ³ã‚­ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆæ®‹ã‚Šå…¨éƒ¨ï¼‰ */
  .keypad-area {
    flex: 1; /* æ®‹ã‚Šã‚¹ãƒšãƒ¼ã‚¹æœ€å¤§åŒ– */
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    display: flex; flex-direction: column; 
    gap: 8px; 
    min-height: 0;
  }

  .answer-area {
    display: flex;
    gap: 5px;
    height: 60px; /* å›ºå®šé«˜ã• */
    flex-shrink: 0;
  }

  .answer-display {
    flex: 1;
    background: #fff;
    border: 2px solid #f0e0c8;
    border-radius: 8px;
    font-size: 2.5rem; /* å¤§ãã */
    text-align: right;
    padding-right: 10px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    font-family: 'SorobanFont', sans-serif !important;
  }

  .scroll-buttons {
    display: flex;
    flex-direction: column;
    width: 50px;
    gap: 4px;
  }
  .scroll-btn {
    flex: 1;
    background: #f3e1d2;
    border: 1px solid #d4c4b0;
    border-radius: 6px;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  /* ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰å…¨ä½“ */
  .keypad {
    flex: 1; /* ä¸‹ã¾ã§ä¼¸ã°ã™ */
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding-bottom: 5px;
  }
  .keypad-row {
    flex: 1; /* å‡ç­‰ã«ä¼¸ã°ã™ */
    display: flex;
    gap: 6px;
  }
  .key-btn {
    flex: 1;
    border: none;
    border-radius: 12px;
    background: #fff8e6;
    border-bottom: 4px solid #e0d0b8;
    font-size: 2rem; /* æ•°å­—å¤§ãã */
    font-weight: bold;
    color: #4b3b30;
    touch-action: manipulation;
  }
  .key-btn:active {
    transform: translateY(2px);
    border-bottom-width: 2px;
    background: #f3e1d2;
  }
  
  /* æ©Ÿèƒ½ã‚­ãƒ¼ */
  .key-btn.action {
    font-size: 1.4rem;
    background: #e8d0b8; 
    border-bottom-color: #cbb094;
  }
</style>
</BaseLayout>